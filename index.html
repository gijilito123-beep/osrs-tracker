<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OSRS Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap');
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f5f3f0 0%, #e8e3dd 100%); color: #2d2416; min-height: 100vh; }
    .header { background: linear-gradient(135deg, #1a1410 0%, #3d3428 100%); color: #d4af37; padding: 1.5rem; border-bottom: 3px solid #d4af37; }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
    .header h1 { font-family: 'Cinzel', serif; font-size: 1.8rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
    .header h1:hover { text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
    .header-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.8rem; }
    .info-card { background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 6px; padding: 0.6rem 0.8rem; font-size: 0.8rem; }
    .info-label { opacity: 0.7; margin-bottom: 0.2rem; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }
    .info-value { font-weight: 700; font-size: 0.9rem; color: #d4af37; }
    .info-sub { opacity: 0.6; font-size: 0.65rem; margin-top: 0.1rem; }
    .header-tasas { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.8rem; }
    .tasa-mini { background: rgba(212, 175, 55, 0.08); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 6px; padding: 0.5rem; font-size: 0.75rem; }
    .tasa-mini-label { opacity: 0.6; margin-bottom: 0.1rem; }
    .tasa-mini-value { font-weight: 700; color: #d4af37; font-size: 0.85rem; }
    .container { max-width: 1100px; margin: 0 auto; padding: 1rem; }
    .section-title { font-family: 'Cinzel', serif; font-size: 1.1rem; font-weight: 700; margin: 1.5rem 0 0.8rem 0; color: #1a1410; border-bottom: 2px solid #d4af37; padding-bottom: 0.5rem; }
    .card { background: white; border-radius: 8px; padding: 1.2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1.5rem; border-left: 4px solid #d4af37; }
    .btn-primary { background: #d4af37; color: #1a1410; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.9rem; transition: all 0.2s; }
    .btn-primary:hover { background: #e8c547; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3); }
    .btn-secondary { background: #f5f3f0; color: #2d2416; border: 1px solid #d4af37; padding: 0.5rem 0.9rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
    .btn-secondary:hover { background: #e8e3dd; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.8rem; margin-bottom: 1.2rem; }
    .stat-card { background: white; border-radius: 8px; padding: 0.9rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); text-align: center; border-top: 3px solid #d4af37; }
    .stat-icon { font-size: 1.3rem; margin-bottom: 0.2rem; }
    .stat-label { font-size: 0.7rem; color: #6b7280; margin-bottom: 0.2rem; }
    .stat-value { font-size: 1rem; font-weight: 800; color: #d4af37; }
    .table-wrapper { overflow-x: auto; max-height: 600px; overflow-y: auto; border: 1px solid #d4af37; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { background: linear-gradient(135deg, #2d2416 0%, #3d3428 100%); padding: 0.8rem; text-align: left; font-weight: 700; color: #d4af37; border-bottom: 2px solid #d4af37; position: sticky; top: 0; }
    td { padding: 0.7rem; border-bottom: 1px solid #e8e3dd; }
    tr:hover { background: #f9f7f4; }
    .gp-cell { color: #d4af37; font-weight: 700; cursor: pointer; padding: 0.3rem 0.5rem; border-radius: 4px; }
    .gp-cell:hover { background: rgba(212, 175, 55, 0.1); }
    .btn-delete { background: #fee2e2; color: #991b1b; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 600; }
    .btn-delete:hover { background: #fecaca; }
    .pagination { display: flex; gap: 0.5rem; align-items: center; justify-content: center; margin-top: 1rem; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 10px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 90vh; overflow-y: auto; border-left: 4px solid #d4af37; }
    .modal-content h2 { margin-bottom: 1rem; font-size: 1.1rem; color: #1a1410; }
    .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 0.6rem; margin-bottom: 0.8rem; border: 1px solid #d4af37; border-radius: 6px; font-size: 0.9rem; }
    .modal-buttons { display: flex; gap: 0.8rem; }
    .modal-buttons button { flex: 1; padding: 0.6rem; }
    .chart-container { position: relative; height: 280px; margin-top: 1rem; }
    .objetivo-item { background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 0.8rem; border-left: 4px solid #d4af37; }
    .objetivo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .objetivo-name { font-weight: 700; color: #1a1410; }
    .progress-bar { background: #e8e3dd; height: 8px; border-radius: 999px; overflow: hidden; margin-bottom: 0.5rem; }
    .progress-fill { background: linear-gradient(90deg, #d4af37, #e8c547); height: 100%; border-radius: 999px; }
    .objetivo-values { display: flex; justify-content: space-between; font-size: 0.8rem; }
    .membresia-card { background: linear-gradient(135deg, #d4af37 0%, #e8c547 100%); border-radius: 8px; padding: 1.2rem; color: #1a1410; }
    .membresia-label { font-size: 0.8rem; opacity: 0.8; margin-bottom: 0.3rem; font-weight: 700; }
    .membresia-value { font-size: 1.4rem; font-weight: 800; margin-bottom: 0.5rem; }
    .membresia-warning { background: #fee2e2; color: #991b1b; border-radius: 6px; padding: 0.6rem; margin-top: 0.8rem; font-size: 0.8rem; font-weight: 600; }
    footer { background: #1a1410; color: #d4af37; text-align: center; padding: 1rem; margin-top: 2rem; font-size: 0.8rem; border-top: 2px solid #d4af37; }
    .editable-title { position: relative; display: inline-block; }
    .editable-title:hover { opacity: 0.8; }
    @media (max-width: 768px) {
      .header { padding: 1rem; }
      .header h1 { font-size: 1.4rem; }
      .container { padding: 0.8rem; }
      .header-info { grid-template-columns: 1fr; }
      .header-tasas { grid-template-columns: repeat(3, 1fr); }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .table-wrapper { max-height: 400px; }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <h1 class="editable-title" id="projectTitle" onclick="abrirModalTitulo()">Proyecto Moto/PC</h1>
    <div class="header-tasas" id="headerTasas"></div>
  </div>
  <div class="header-info">
    <div class="info-card">
      <div class="info-label">üìÖ Inicio</div>
      <div class="info-value">11-Feb-2026</div>
    </div>
    <div class="info-card">
      <div class="info-label">üìç Ubicaci√≥n</div>
      <div class="info-value">Matur√≠n, VE</div>
    </div>
    <div class="info-card" onclick="abrirModalBank()" style="cursor: pointer;">
      <div class="info-label">üí∞ Bank Actual</div>
      <div class="info-value" id="bankGP">44.5 m</div>
      <div class="info-sub" id="bankResumen">0 Bs ‚Ä¢ $0 BCV ‚Ä¢ $0 Binance</div>
    </div>
  </div>
</div>

<div class="container">

  <!-- PAGOS DEL CURSO -->
  <div class="section-title">üí∏ Pagos del Curso</div>
  <div class="card">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Mes</th>
            <th>L√≠mite</th>
            <th>Monto</th>
            <th>Bs</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="pagosBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- METAS -->
  <div class="section-title">üéØ Metas Principales</div>
  <div class="card">
    <div id="metasGrid"></div>
  </div>

  <!-- MEMBRES√çA -->
  <div class="section-title">üé´ Membres√≠a OSRS</div>
  <div class="card">
    <div class="membresia-card">
      <div class="membresia-label">D√≠as Restantes</div>
      <div class="membresia-value" id="diasRestantes">8</div>
      <div style="font-size: 0.75rem; opacity: 0.8;">
        <div>Comprada: 15 Feb 2026</div>
        <div>Vencimiento: 28 Feb 2026</div>
        <div style="margin-top: 0.3rem;">Precio: $10.99 (5,930 Bs)</div>
      </div>
      <div class="membresia-warning" id="membresia-warning">‚ö†Ô∏è Renovar antes del 28 de febrero</div>
    </div>
  </div>

  <!-- FARMEO -->
  <div class="section-title">üìÖ Farmeo Diario</div>
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
      <button class="btn-primary" onclick="abrirModalFarmeo()">‚ûï A√±adir D√≠a</button>
      <div class="pagination">
        <button class="btn-secondary" onclick="paginaAnterior()">‚Üê Anterior</button>
        <span style="font-weight: 600; min-width: 50px; text-align: center;" id="paginaInfo">1/1</span>
        <button class="btn-secondary" onclick="paginaSiguiente()">Siguiente ‚Üí</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>D√≠a</th>
            <th>Fecha</th>
            <th>GP / 15-20m</th>
            <th>ToB</th>
            <th>Drops</th>
            <th>Notas</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="farmeoBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- GR√ÅFICA -->
  <div class="section-title">üìà Gr√°fica de Progreso</div>
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
      <button class="btn-secondary" onclick="mesAnterior()">‚Üê Mes Anterior</button>
      <span style="font-weight: 600;" id="mesActual">Febrero 2026</span>
      <button class="btn-secondary" onclick="mesSiguiente()">Mes Siguiente ‚Üí</button>
    </div>
    <div class="chart-container">
      <canvas id="farmeoChart"></canvas>
    </div>
  </div>

  <!-- AN√ÅLISIS -->
  <div class="section-title">üìä An√°lisis de Rendimiento</div>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üìà</div>
      <div class="stat-label">Promedio</div>
      <div class="stat-value" id="promedioDiario">0 m</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìÖ</div>
      <div class="stat-label">Total</div>
      <div class="stat-value" id="totalGenerado">0 m</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚ö°</div>
      <div class="stat-label">D√≠as</div>
      <div class="stat-value" id="totalDias">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üíé</div>
      <div class="stat-label">Bank USD</div>
      <div class="stat-value" id="valorBank">$0</div>
    </div>
  </div>

</div>

<!-- MODALES -->
<div id="modalTitulo" class="modal">
  <div class="modal-content">
    <h2>Editar Nombre del Proyecto</h2>
    <input type="text" id="inputTitulo" placeholder="Nombre del proyecto" />
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalTitulo()">Cancelar</button>
      <button class="btn-primary" onclick="guardarTitulo()">Guardar</button>
    </div>
  </div>
</div>

<div id="modalFarmeo" class="modal">
  <div class="modal-content">
    <h2>‚ûï A√±adir D√≠a de Farmeo</h2>
    <input type="date" id="farmeoFecha" />
    <input type="number" id="farmeoGP" placeholder="GP Farmeado (millones)" step="0.1" />
    <input type="number" id="farmeoToB" placeholder="ToB (cantidad)" step="1" />
    <select id="farmeoPurple" onchange="togglePurpleInput()">
      <option value="none">Sin Purple</option>
      <option value="scythe">Scythe of Vitur (1600m)</option>
      <option value="sang">Sang Staff (19.6m)</option>
      <option value="justiciar_face">Justiciar Faceguard (0.18m)</option>
      <option value="justiciar_body">Justiciar Body (0.25m)</option>
      <option value="justiciar_legs">Justiciar Legs (0.22m)</option>
      <option value="ghrazi">Ghrazi Rapier (31m)</option>
      <option value="avernic">Avernic Defender (0.09m)</option>
      <option value="other">Otro (especificar GP)</option>
    </select>
    <input type="number" id="farmeoPurpleGP" placeholder="GP del Purple (millones)" step="0.1" style="display: none;" />
    <textarea id="farmeoNotas" placeholder="Notas" rows="2"></textarea>
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalFarmeo()">Cancelar</button>
      <button class="btn-primary" onclick="guardarFarmeo()">Guardar</button>
    </div>
  </div>
</div>

<div id="modalEditarFarmeo" class="modal">
  <div class="modal-content">
    <h2>‚úèÔ∏è Editar D√≠a de Farmeo</h2>
    <input type="date" id="editFarmeoFecha" />
    <input type="number" id="editFarmeoGP" placeholder="GP Farmeado (millones)" step="0.1" />
    <input type="number" id="editFarmeoToB" placeholder="ToB (cantidad)" step="1" />
    <textarea id="editFarmeoNotas" placeholder="Notas" rows="2"></textarea>
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalEditarFarmeo()">Cancelar</button>
      <button class="btn-primary" onclick="guardarEditarFarmeo()">Guardar Cambios</button>
    </div>
  </div>
</div>

<div id="modalBank" class="modal">
  <div class="modal-content">
    <h2>Editar Bank Actual</h2>
    <input type="number" id="inputBankGP" placeholder="Bank (millones de GP)" step="0.1" />
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalBank()">Cancelar</button>
      <button class="btn-primary" onclick="guardarBank()">Guardar</button>
    </div>
  </div>
</div>

<div id="modalTasaGP" class="modal">
  <div class="modal-content">
    <h2>Editar Tasa GP/USD (Binance)</h2>
    <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">Esta es la tasa de conversi√≥n de GP a USD en Binance. Aj√∫stala seg√∫n el mercado actual.</p>
    <input type="number" id="inputTasaGP" placeholder="Tasa GP/USD" step="0.00001" />
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalTasaGP()">Cancelar</button>
      <button class="btn-primary" onclick="guardarTasaGP()">Guardar</button>
    </div>
  </div>
</div>

<footer>
  <p>‚öîÔ∏è OSRS Tracker v2.0 ‚Ä¢ Proyecto Moto/PC ‚Ä¢ √öltima actualizaci√≥n: 20 de febrero de 2026</p>
</footer>

<script>
  let state = {
    projectName: "Proyecto Moto/PC",
    nextId: 12,
    farmeo: [],
    objetivos: [],
    tasaGP: 0.0002,
    tasaBCV: 402.3343,
    tasaBinance: 583,
    bankActualGP: 44.5,
    pagos: [],
    membresia: {}
  };

  let tasaBCVActual = 402.3343;
  let tasaBinanceActual = 583;
  let chartFarmeo = null;
  let paginaActualFarmeo = 1;
  const diasPorPagina = 31;
  let mesActualGrafica = new Date();
  let editandoFarmeoId = null;

  const preciosPurples = {
    'scythe': 1600, 'sang': 19.6, 'justiciar_face': 0.18, 'justiciar_body': 0.25,
    'justiciar_legs': 0.22, 'ghrazi': 31, 'avernic': 0.09
  };

  // GUARDAR DATOS EN LOCALSTORAGE
  function guardarDatos() {
    localStorage.setItem('osrs_tracker_state', JSON.stringify(state));
    console.log("‚úÖ Datos guardados en localStorage");
  }

  // CARGAR DATOS
  async function cargarDatos() {
    const saved = localStorage.getItem('osrs_tracker_state');
    if (saved) {
      state = JSON.parse(saved);
      console.log("‚úÖ Datos cargados desde localStorage");
    } else {
      try {
        const response = await fetch("data.json?t=" + Date.now());
        if (response.ok) {
          const data = await response.json();
          state = data;
          guardarDatos();
          console.log("‚úÖ Datos cargados desde data.json");
        }
      } catch (e) {
        console.error("‚ùå Error cargando datos:", e);
      }
    }
    tasaBCVActual = state.tasaBCV;
    tasaBinanceActual = state.tasaBinance;
  }

  function formatFecha(f) {
    const d = new Date(f + 'T00:00:00Z');
    return d.toLocaleDateString('es-VE');
  }

  function actualizarTotales() {
    let totalGP = 0;
    state.farmeo.forEach(d => totalGP += d.gp);
    const promedio = state.farmeo.length > 0 ? totalGP / state.farmeo.length : 0;
    const usd = totalGP * state.tasaGP;
    document.getElementById('totalGenerado').textContent = totalGP.toFixed(1) + ' m';
    document.getElementById('promedioDiario').textContent = promedio.toFixed(1) + ' m';
    document.getElementById('totalDias').textContent = state.farmeo.length;
    document.getElementById('valorBank').textContent = '$' + usd.toFixed(2);
  }

  // TASAS EN HEADER
  function renderHeaderTasas() {
    const html = `
      <div class="tasa-mini">
        <div class="tasa-mini-label">BCV</div>
        <div class="tasa-mini-value">${tasaBCVActual.toFixed(2)}</div>
      </div>
      <div class="tasa-mini">
        <div class="tasa-mini-label">Binance P2P</div>
        <div class="tasa-mini-value">${tasaBinanceActual.toFixed(2)}</div>
      </div>
      <div class="tasa-mini" onclick="abrirModalTasaGP()" style="cursor: pointer;">
        <div class="tasa-mini-label">GP/USD</div>
        <div class="tasa-mini-value">${state.tasaGP.toFixed(5)}</div>
      </div>
    `;
    document.getElementById('headerTasas').innerHTML = html;
  }

  // BANK
  function renderBank() {
    document.getElementById('bankGP').textContent = state.bankActualGP.toFixed(1) + ' m';
    const usd_bcv = state.bankActualGP * state.tasaGP;
    const usd_binance = state.bankActualGP * state.tasaGP;
    const bs = usd_bcv * tasaBCVActual;
    document.getElementById('bankResumen').textContent = 
      bs.toFixed(0) + ' Bs ‚Ä¢ $' + usd_bcv.toFixed(2) + ' BCV ‚Ä¢ $' + usd_binance.toFixed(2) + ' Binance';
  }

  function abrirModalBank() {
    document.getElementById('inputBankGP').value = state.bankActualGP;
    document.getElementById('modalBank').classList.add('active');
  }

  function cerrarModalBank() {
    document.getElementById('modalBank').classList.remove('active');
  }

  function guardarBank() {
    const val = parseFloat(document.getElementById('inputBankGP').value);
    if (!isNaN(val)) {
      state.bankActualGP = val;
      guardarDatos();
      renderBank();
      actualizarTotales();
      cerrarModalBank();
    }
  }

  // TASA DE GP
  function abrirModalTasaGP() {
    document.getElementById('inputTasaGP').value = state.tasaGP;
    document.getElementById('modalTasaGP').classList.add('active');
  }

  function cerrarModalTasaGP() {
    document.getElementById('modalTasaGP').classList.remove('active');
  }

  function guardarTasaGP() {
    const val = parseFloat(document.getElementById('inputTasaGP').value);
    if (!isNaN(val) && val > 0) {
      state.tasaGP = val;
      guardarDatos();
      renderHeaderTasas();
      renderBank();
      actualizarTotales();
      renderMetas();
      cerrarModalTasaGP();
      console.log('‚úÖ Tasa GP actualizada a:', val);
    } else {
      alert('Por favor ingresa un valor v√°lido mayor a 0');
    }
  }

  // T√çTULO DEL PROYECTO
  function abrirModalTitulo() {
    document.getElementById('inputTitulo').value = state.projectName;
    document.getElementById('modalTitulo').classList.add('active');
  }

  function cerrarModalTitulo() {
    document.getElementById('modalTitulo').classList.remove('active');
  }

  function guardarTitulo() {
    const val = document.getElementById('inputTitulo').value.trim();
    if (val) {
      state.projectName = val;
      document.getElementById('projectTitle').textContent = val;
      guardarDatos();
      cerrarModalTitulo();
    }
  }

  // FARMEO
  function abrirModalFarmeo() {
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('farmeoFecha').value = hoy;
    document.getElementById('farmeoGP').value = '';
    document.getElementById('farmeoToB').value = '';
    document.getElementById('farmeoPurple').value = 'none';
    document.getElementById('farmeoNotas').value = '';
    document.getElementById('farmeoPurpleGP').style.display = 'none';
    document.getElementById('modalFarmeo').classList.add('active');
  }

  function cerrarModalFarmeo() {
    document.getElementById('modalFarmeo').classList.remove('active');
  }

  function togglePurpleInput() {
    const val = document.getElementById('farmeoPurple').value;
    document.getElementById('farmeoPurpleGP').style.display = (val === 'other') ? 'block' : 'none';
  }

  function guardarFarmeo() {
    const fecha = document.getElementById('farmeoFecha').value;
    let gp = parseFloat(document.getElementById('farmeoGP').value) || 0;
    const tob = parseInt(document.getElementById('farmeoToB').value) || 0;
    const purple = document.getElementById('farmeoPurple').value;
    let notas = document.getElementById('farmeoNotas').value;

    if (!fecha) { alert('Selecciona una fecha'); return; }

    if (purple !== 'none' && purple !== 'other') {
      const precio = preciosPurples[purple] || 0;
      gp += precio;
      notas += ` [${purple}: ${precio}m]`;
    } else if (purple === 'other') {
      const precio = parseFloat(document.getElementById('farmeoPurpleGP').value) || 0;
      if (precio > 0) {
        gp += precio;
        notas += ` [Purple: ${precio}m]`;
      }
    }

    state.farmeo.push({ id: state.nextId++, fecha, gp, tob, notas });
    state.farmeo.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    guardarDatos();
    renderFarmeo();
    cerrarModalFarmeo();
  }

  function abrirModalEditarFarmeo(id) {
    const dia = state.farmeo.find(d => d.id === id);
    if (!dia) return;
    editandoFarmeoId = id;
    document.getElementById('editFarmeoFecha').value = dia.fecha;
    document.getElementById('editFarmeoGP').value = dia.gp;
    document.getElementById('editFarmeoToB').value = dia.tob;
    document.getElementById('editFarmeoNotas').value = dia.notas;
    document.getElementById('modalEditarFarmeo').classList.add('active');
  }

  function cerrarModalEditarFarmeo() {
    document.getElementById('modalEditarFarmeo').classList.remove('active');
    editandoFarmeoId = null;
  }

  function guardarEditarFarmeo() {
    if (!editandoFarmeoId) return;
    const dia = state.farmeo.find(d => d.id === editandoFarmeoId);
    if (!dia) return;

    dia.fecha = document.getElementById('editFarmeoFecha').value;
    dia.gp = parseFloat(document.getElementById('editFarmeoGP').value) || 0;
    dia.tob = parseInt(document.getElementById('editFarmeoToB').value) || 0;
    dia.notas = document.getElementById('editFarmeoNotas').value;

    state.farmeo.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    guardarDatos();
    renderFarmeo();
    cerrarModalEditarFarmeo();
  }

  function renderFarmeo() {
    const tbody = document.getElementById('farmeoBody');
    tbody.innerHTML = '';

    const totalPags = Math.ceil(state.farmeo.length / diasPorPagina) || 1;
    const inicio = (paginaActualFarmeo - 1) * diasPorPagina;
    const diasPag = state.farmeo.slice(inicio, inicio + diasPorPagina);

    diasPag.forEach(dia => {
      const idx = state.farmeo.indexOf(dia) + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx}</td>
        <td>${formatFecha(dia.fecha)}</td>
        <td class="gp-cell" onclick="abrirModalEditarFarmeo(${dia.id})">${dia.gp.toFixed(1)} / 15-20m</td>
        <td>${dia.tob || 0} / 5</td>
        <td>${dia.notas.includes('[') ? 'üíé' : '‚Äî'}</td>
        <td title="${dia.notas}" style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${dia.notas}</td>
        <td><button class="btn-delete" onclick="eliminarDia(${dia.id})">üóë</button></td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('paginaInfo').textContent = `${paginaActualFarmeo}/${totalPags}`;
    actualizarTotales();
    renderGrafica();
  }

  function eliminarDia(id) {
    if (confirm('¬øEliminar este d√≠a?')) {
      state.farmeo = state.farmeo.filter(d => d.id !== id);
      guardarDatos();
      renderFarmeo();
    }
  }

  function paginaAnterior() {
    if (paginaActualFarmeo > 1) {
      paginaActualFarmeo--;
      renderFarmeo();
    }
  }

  function paginaSiguiente() {
    const total = Math.ceil(state.farmeo.length / diasPorPagina);
    if (paginaActualFarmeo < total) {
      paginaActualFarmeo++;
      renderFarmeo();
    }
  }

  // GR√ÅFICA
  function renderGrafica() {
    const mes = mesActualGrafica.getMonth();
    const a√±o = mesActualGrafica.getFullYear();
    const dias = state.farmeo.filter(d => {
      const f = new Date(d.fecha + 'T00:00:00Z');
      return f.getUTCMonth() === mes && f.getUTCFullYear() === a√±o;
    });

    const labels = dias.map(d => 'D' + new Date(d.fecha + 'T00:00:00Z').getUTCDate());
    const datos = dias.map(d => d.gp);

    const ctx = document.getElementById('farmeoChart');
    if (!ctx) return;
    if (chartFarmeo) chartFarmeo.destroy();

    chartFarmeo = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'GP Farmeado',
          data: datos,
          backgroundColor: '#d4af37',
          borderColor: '#e8c547',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: true, labels: { color: '#2d2416' } } },
        scales: { y: { beginAtZero: true, ticks: { color: '#2d2416' }, grid: { color: '#e8e3dd' } }, x: { ticks: { color: '#2d2416' }, grid: { color: '#e8e3dd' } } }
      }
    });

    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    document.getElementById('mesActual').textContent = meses[mes] + ' ' + a√±o;
  }

  function mesAnterior() {
    mesActualGrafica.setMonth(mesActualGrafica.getMonth() - 1);
    renderGrafica();
  }

  function mesSiguiente() {
    mesActualGrafica.setMonth(mesActualGrafica.getMonth() + 1);
    renderGrafica();
  }

  // METAS
  function renderMetas() {
    const grid = document.getElementById('metasGrid');
    grid.innerHTML = '';
    state.objetivos.forEach(obj => {
      let metaGP = obj.meta;
      if (obj.tipo === 'moto' || obj.tipo === 'pc') {
        metaGP = (obj.metaUSD / state.tasaGP) / tasaBinanceActual;
      }
      const pct = Math.min((obj.actual / metaGP) * 100, 100);
      const div = document.createElement('div');
      div.className = 'objetivo-item';
      let html = `
        <div class="objetivo-header">
          <span class="objetivo-name">${obj.nombre}</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${pct}%"></div>
        </div>
      `;
      
      if (obj.tipo === 'lms') {
        html += `
          <div class="objetivo-values">
            <span>Actual: <strong>${obj.actual}</strong> pts</span>
            <span>Meta: <strong>${obj.meta}</strong> pts</span>
          </div>
          <div style="font-size: 0.75rem; color: #6b7280;">üìÖ ${obj.plazo}</div>
          <div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.3rem;">D6: ${obj.detalles.dia6} | D7: ${obj.detalles.dia7} | D8: ${obj.detalles.dia8} | D9: ${obj.detalles.dia9}</div>
        `;
      } else {
        html += `
          <div class="objetivo-values">
            <span>Actual: <strong contenteditable="true" onblur="editarActualMeta(${obj.id}, this.textContent)">${obj.actual.toFixed(2)}</strong> m</span>
            <span>Meta: <strong>${metaGP.toFixed(2)}</strong> m</span>
          </div>
          <div style="font-size: 0.75rem; color: #6b7280;">üìÖ ${obj.plazo}</div>
        `;
      }
      
      div.innerHTML = html;
      grid.appendChild(div);
    });
  }

  function editarActualMeta(id, text) {
    const obj = state.objetivos.find(o => o.id === id);
    if (obj) {
      const val = parseFloat(text);
      if (!isNaN(val)) {
        obj.actual = val;
        guardarDatos();
        renderMetas();
      }
    }
  }

  // PAGOS
  function renderPagos() {
    const tbody = document.getElementById('pagosBody');
    tbody.innerHTML = '';

    state.pagos.forEach(pago => {
      const hoy = new Date();
      const limite = new Date(pago.fechaLimite + 'T00:00:00Z');
      let monto = pago.monto;
      let estado = pago.estado;
      let color = '#fef3c7';
      let textColor = '#92400e';

      if (estado === 'Pagado') {
        color = '#d1fae5';
        textColor = '#065f46';
      } else if (limite < hoy && estado === 'Pendiente') {
        monto *= 1.5;
        estado = 'Mora';
        color = '#fee2e2';
        textColor = '#991b1b';
        pago.estado = 'Mora';
      } else if (estado === 'Mora') {
        monto *= 1.5;
        color = '#fee2e2';
        textColor = '#991b1b';
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${pago.mes}</td>
        <td>${formatFecha(pago.fechaLimite)}</td>
        <td style="color: #d4af37; font-weight: 700;">$${monto.toFixed(2)}</td>
        <td>${(monto * tasaBCVActual).toFixed(0)} Bs</td>
        <td><button class="btn-secondary" onclick="toggleEstadoPago(${pago.id})" style="background: ${color}; color: ${textColor}; border: none; padding: 0.3rem 0.6rem;">${estado}</button></td>
      `;
      tbody.appendChild(tr);
    });

    guardarDatos();
  }

  function toggleEstadoPago(id) {
    const pago = state.pagos.find(p => p.id === id);
    if (pago) {
      if (pago.estado === 'Pendiente') pago.estado = 'Pagado';
      else if (pago.estado === 'Pagado') pago.estado = 'Pendiente';
      else if (pago.estado === 'Mora') pago.estado = 'Pagado';
      guardarDatos();
      renderPagos();
    }
  }

  // MEMBRES√çA
  function renderMembresia() {
    if (!state.membresia.fechaCompra) return;
    const fechaVencimiento = new Date(state.membresia.fechaVencimiento + 'T00:00:00Z');
    const hoy = new Date();
    let diasRestantes = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));
    if (diasRestantes < 0) diasRestantes = 0;

    document.getElementById('diasRestantes').textContent = diasRestantes;
    const warning = document.getElementById('membresia-warning');
    if (diasRestantes <= 7) {
      warning.style.display = 'block';
      warning.textContent = `‚ö†Ô∏è ${diasRestantes} d√≠as para renovar (vence ${formatFecha(state.membresia.fechaVencimiento)})`;
    } else {
      warning.style.display = 'none';
    }
  }

  // INICIALIZAR
  async function init() {
    await cargarDatos();
    renderHeaderTasas();
    renderBank();
    renderFarmeo();
    renderMetas();
    renderPagos();
    renderMembresia();
    document.getElementById('projectTitle').textContent = state.projectName;
    console.log("‚úÖ Aplicaci√≥n inicializada");
  }

  init();
</script>
</body>
</html>
