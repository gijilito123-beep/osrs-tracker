<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Elysian Progress Tracker</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='90' font-weight='bold' fill='%23d4af37'>‚öî</text></svg>" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400;700&display=swap');
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Roboto', sans-serif; background: linear-gradient(135deg, #f5f3f0 0%, #e8e3dd 100%); color: #2d2416; min-height: 100vh; }
    .header { background: linear-gradient(135deg, #1a1410 0%, #3d3428 100%); color: #d4af37; padding: 1.5rem; border-bottom: 3px solid #d4af37; }
    .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
    .header h1 { font-family: 'Cinzel', serif; font-size: 1.8rem; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 0.5rem; }
    .header h1:hover { text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); }
    .header-tasas { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.8rem; flex-grow: 1; max-width: 600px; }
    .tasa-mini { background: rgba(212, 175, 55, 0.08); border: 1px solid rgba(212, 175, 55, 0.2); border-radius: 6px; padding: 0.5rem; font-size: 0.75rem; cursor: pointer; transition: all 0.2s; }
    .tasa-mini:hover { background: rgba(212, 175, 55, 0.15); }
    .tasa-mini-label { opacity: 0.6; margin-bottom: 0.1rem; font-weight: 700; }
    .tasa-mini-value { font-weight: 700; color: #d4af37; font-size: 0.9rem; }
    .tasa-mini-hora { font-size: 0.65rem; opacity: 0.5; margin-top: 0.1rem; }
    .reloj-actual { font-family: 'Cinzel', serif; font-size: 1.2rem; font-weight: 700; color: #d4af37; background: rgba(212, 175, 55, 0.1); padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid #d4af37; }
    .header-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.8rem; }
    .info-card { background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 6px; padding: 0.6rem 0.8rem; font-size: 0.8rem; }
    .info-label { opacity: 0.7; margin-bottom: 0.2rem; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; }
    .info-value { font-weight: 700; font-size: 0.9rem; color: #d4af37; }
    .info-sub { opacity: 0.6; font-size: 0.65rem; margin-top: 0.1rem; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .section-title { font-family: 'Cinzel', serif; font-size: 1.2rem; font-weight: 700; margin: 1.5rem 0 0.8rem 0; color: #1a1410; border-bottom: 2px solid #d4af37; padding-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .card { background: white; border-radius: 8px; padding: 1.2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1.5rem; border-left: 4px solid #d4af37; }
    .btn-primary { background: #d4af37; color: #1a1410; border: none; padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.9rem; transition: all 0.2s; }
    .btn-primary:hover { background: #e8c547; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3); }
    .btn-secondary { background: #f5f3f0; color: #2d2416; border: 1px solid #d4af37; padding: 0.5rem 0.9rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
    .btn-secondary:hover { background: #e8e3dd; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.8rem; margin-bottom: 1.2rem; }
    .stat-card { background: white; border-radius: 8px; padding: 0.9rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); text-align: center; border-top: 3px solid #d4af37; }
    .stat-icon { font-size: 1.3rem; margin-bottom: 0.2rem; }
    .stat-label { font-size: 0.7rem; color: #6b7280; margin-bottom: 0.2rem; }
    .stat-value { font-size: 1rem; font-weight: 800; color: #d4af37; }
    .table-wrapper { overflow-x: auto; max-height: 600px; overflow-y: auto; border: 1px solid #d4af37; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { background: linear-gradient(135deg, #2d2416 0%, #3d3428 100%); padding: 0.8rem; text-align: left; font-weight: 700; color: #d4af37; border-bottom: 2px solid #d4af37; position: sticky; top: 0; }
    td { padding: 0.7rem; border-bottom: 1px solid #e8e3dd; }
    tr:hover { background: #f9f7f4; }
    .gp-cell { color: #d4af37; font-weight: 700; cursor: pointer; padding: 0.3rem 0.5rem; border-radius: 4px; }
    .gp-cell:hover { background: rgba(212, 175, 55, 0.1); }
    .btn-delete { background: #fee2e2; color: #991b1b; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 600; }
    .btn-delete:hover { background: #fecaca; }
    .btn-edit { background: #dbeafe; color: #1e40af; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 600; margin-right: 0.3rem; }
    .btn-edit:hover { background: #bfdbfe; }
    .pagination { display: flex; gap: 0.5rem; align-items: center; justify-content: center; margin-top: 1rem; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 10px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 90vh; overflow-y: auto; border-left: 4px solid #d4af37; }
    .modal-content h2 { margin-bottom: 1rem; font-size: 1.1rem; color: #1a1410; font-family: 'Cinzel', serif; }
    .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 0.6rem; margin-bottom: 0.8rem; border: 1px solid #d4af37; border-radius: 6px; font-size: 0.9rem; }
    .modal-buttons { display: flex; gap: 0.8rem; }
    .modal-buttons button { flex: 1; padding: 0.6rem; }
    .chart-container { position: relative; height: 350px; margin-top: 1rem; }
    .objetivo-item { background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 0.8rem; border-left: 4px solid #d4af37; }
    .objetivo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .objetivo-name { font-weight: 700; color: #1a1410; }
    .progress-bar { background: #e8e3dd; height: 10px; border-radius: 999px; overflow: hidden; margin-bottom: 0.5rem; }
    .progress-fill { background: linear-gradient(90deg, #d4af37, #e8c547); height: 100%; border-radius: 999px; transition: width 0.5s ease-in-out; }
    .objetivo-values { display: flex; justify-content: space-between; font-size: 0.8rem; }
    .membresia-card { background: linear-gradient(135deg, #d4af37 0%, #e8c547 100%); border-radius: 8px; padding: 1.2rem; color: #1a1410; }
    .membresia-label { font-size: 0.8rem; opacity: 0.8; margin-bottom: 0.3rem; font-weight: 700; }
    .membresia-value { font-size: 1.4rem; font-weight: 800; margin-bottom: 0.5rem; }
    .search-section { background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1.5rem; border-left: 4px solid #d4af37; }
    .search-box { display: flex; gap: 0.8rem; margin-bottom: 1rem; }
    .search-box input { flex: 1; padding: 0.8rem; border: 1px solid #d4af37; border-radius: 6px; font-size: 0.9rem; }
    .search-results { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
    .item-card { background: #f9f7f4; border: 1px solid #d4af37; border-radius: 8px; padding: 1rem; text-align: center; }
    .item-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .item-name { font-weight: 700; color: #1a1410; margin-bottom: 0.3rem; }
    .item-price { color: #d4af37; font-weight: 700; font-size: 0.95rem; margin-bottom: 0.2rem; }
    .item-details { font-size: 0.8rem; color: #6b7280; margin-bottom: 0.3rem; }
    footer { background: #1a1410; color: #d4af37; text-align: center; padding: 1rem; margin-top: 2rem; font-size: 0.8rem; border-top: 2px solid #d4af37; }
    @media (max-width: 768px) {
      .header-top { flex-direction: column; align-items: flex-start; }
      .header-tasas { width: 100%; grid-template-columns: repeat(2, 1fr); }
      .reloj-actual { width: 100%; text-align: center; }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <h1 id="projectTitle" onclick="abrirModalTitulo()">‚öîÔ∏è Elysian Progress</h1>
    <div class="header-tasas" id="headerTasas"></div>
    <div class="tasa-mini" style="background: rgba(139, 92, 246, 0.1); border-color: rgba(139, 92, 246, 0.3);">
      <div class="tasa-mini-label">Binance P2P</div>
      <div class="tasa-mini-value" id="tasaBinanceDisplay">583</div>
      <div class="tasa-mini-hora" id="tasaBinanceHora">--:--:-- --</div>
    </div>
    <div class="reloj-actual" id="relojActual">00:00:00 AM</div>
  </div>
  <div class="header-info">
    <div class="info-card">
      <div class="info-label">üìÖ Inicio</div>
      <div class="info-value">11-Feb-2026</div>
    </div>
    <div class="info-card">
      <div class="info-label">üìç Ubicaci√≥n</div>
      <div class="info-value">Matur√≠n, VE</div>
    </div>
    <div class="info-card" onclick="abrirModal('modalBank')" style="cursor: pointer;">
      <div class="info-label">üí∞ Bank Actual</div>
      <div class="info-value" id="bankGP">0 m</div>
      <div class="info-sub" id="bankResumen">0 Bs ‚Ä¢ $0 Binance ‚Ä¢ $0 BCV</div>
    </div>
  </div>
</div>

<div class="container">
  <div class="card">
    <h2 class="section-title">üí≥ Pagos del Curso</h2>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Mes</th>
            <th>L√≠mite</th>
            <th>Monto</th>
            <th>Bs (BCV)</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="pagosBody"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2 class="section-title">üéØ Metas del Proyecto</h2>
    <div id="metasGrid"></div>
  </div>

  <div class="card">
    <h2 class="section-title">üîë Membres√≠a OSRS</h2>
    <div id="membresia"></div>
  </div>

  <div class="card">
    <h2 class="section-title">‚öîÔ∏è Progreso de Farmeo</h2>
    <button class="btn-primary" onclick="abrirModalFarmeo()" style="margin-bottom: 1rem;">‚ûï A√±adir D√≠a</button>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-label">Total</div><div class="stat-value" id="totalGenerado">0 m</div></div>
      <div class="stat-card"><div class="stat-icon">üìä</div><div class="stat-label">Promedio</div><div class="stat-value" id="promedioDiario">0 m</div></div>
      <div class="stat-card"><div class="stat-icon">üìÖ</div><div class="stat-label">D√≠as</div><div class="stat-value" id="totalDias">0</div></div>
      <div class="stat-card"><div class="stat-icon">üíµ</div><div class="stat-label">Valor USD</div><div class="stat-value" id="valorBank">$0</div></div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Fecha</th>
            <th>GP / 15-20m</th>
            <th>ToB</th>
            <th>Drop</th>
            <th>Notas</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="farmeoBody"></tbody>
      </table>
    </div>
    <div class="pagination">
      <button class="btn-secondary" onclick="paginaAnterior()">‚Üê Anterior</button>
      <span id="paginaInfo">1/1</span>
      <button class="btn-secondary" onclick="paginaSiguiente()">Siguiente ‚Üí</button>
    </div>
  </div>

  <div class="card">
    <h2 class="section-title">üìà Gr√°fica de Progreso</h2>
    <div class="chart-container">
      <canvas id="farmeoChart"></canvas>
    </div>
  </div>

  <div class="search-section">
    <h2 class="section-title">üîç Buscador de Items OSRS</h2>
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Busca un item (ej: Scythe, Sang Staff...)" />
      <button class="btn-primary" onclick="buscarItem()">Buscar</button>
    </div>
    <div id="searchResults" class="search-results"></div>
  </div>
</div>

<!-- MODALES -->
<div id="modalTitulo" class="modal"><div class="modal-content"><h2>Editar Proyecto</h2><input type="text" id="inputTitulo" /><div class="modal-buttons"><button class="btn-secondary" onclick="cerrarModal('modalTitulo')">Cancelar</button><button class="btn-primary" onclick="guardarTitulo()">Guardar</button></div></div></div>
<div id="modalBank" class="modal"><div class="modal-content"><h2>Editar Bank GP</h2><input type="number" id="inputBankGP" step="0.1" /><div class="modal-buttons"><button class="btn-secondary" onclick="cerrarModal('modalBank')">Cancelar</button><button class="btn-primary" onclick="guardarBank()">Guardar</button></div></div></div>
<div id="modalTasaGP" class="modal"><div class="modal-content"><h2>Editar Tasa m/GP</h2><label>Precio del m en USD (Binance):</label><input type="number" id="inputTasaGPUSD" step="0.00001" /><label>Precio del m en Bs (Binance):</label><input type="number" id="inputTasaGPBS" step="0.01" /><div class="modal-buttons"><button class="btn-secondary" onclick="cerrarModal('modalTasaGP')">Cancelar</button><button class="btn-primary" onclick="guardarTasaGP()">Guardar</button></div></div></div>
<div id="modalBond" class="modal"><div class="modal-content"><h2>Registrar Bond</h2><input type="date" id="bondFecha" /><label>Duraci√≥n:</label><select id="bondDias"><option value="14">14 d√≠as</option><option value="30">30 d√≠as (1 mes)</option><option value="60">60 d√≠as (2 meses)</option><option value="90">90 d√≠as (3 meses)</option><option value="180">180 d√≠as (6 meses)</option><option value="365">365 d√≠as (1 a√±o)</option></select><div class="modal-buttons"><button class="btn-secondary" onclick="cerrarModal('modalBond')">Cancelar</button><button class="btn-primary" onclick="guardarBond()">Guardar</button></div></div></div>
<div id="modalFarmeo" class="modal"><div class="modal-content"><h2 id="modalFarmeoTitle">A√±adir Farmeo</h2><input type="date" id="farmeoFecha" /><input type="number" id="farmeoGP" placeholder="GP (m)" /><input type="number" id="farmeoToB" placeholder="ToB" /><textarea id="farmeoNotas" placeholder="Notas"></textarea><div class="modal-buttons"><button class="btn-secondary" onclick="cerrarModal('modalFarmeo')">Cancelar</button><button class="btn-primary" onclick="guardarFarmeo()">Guardar</button></div></div></div>
<div id="modalNuevoObjetivo" class="modal"><div class="modal-content"><h2>Nuevo Objetivo</h2><input type="text" id="objNombre" placeholder="Nombre" /><input type="number" id="objMeta" placeholder="Meta" /><label>Tipo de Meta:</label><select id="objTipo"><option value="gp">m (Millones de GP)</option><option value="bcv">$ (Tasa BCV)</option><option value="binance">$ (Tasa Binance)</option></select><div class="modal-buttons"><button class="btn-secondary" onclick="cerrarModal('modalNuevoObjetivo')">Cancelar</button><button class="btn-primary" onclick="guardarNuevoObjetivo()">Guardar</button></div></div></div>

<footer><p>‚öîÔ∏è Elysian Progress Tracker v3.4 ‚Ä¢ 2026</p></footer>

<script>
  let state = {
    projectName: "‚öîÔ∏è Elysian Progress",
    farmeo: [],
    objetivos: [],
    tasaGPUSD: 0.0002,
    tasaGPBS: 0.1166,
    tasaBCV: 402.33,
    tasaBinance: 583,
    bankActualGP: 0,
    pagos: [],
    membresia: {},
    timestamps: { tasaBCV: "--:--:-- --", tasaBinance: "--:--:-- --", tasaGP: "--:--:-- --" }
  };

  let chartFarmeo = null;
  let paginaActualFarmeo = 1;
  let editandoFarmeoId = null;
  const diasPorPagina = 31;

  function formatGP(num) { return num.toLocaleString('es-VE', { maximumFractionDigits: 1 }); }
  function formatFecha(f) { if(!f) return '--/--/--'; const [y, m, d] = f.split('-'); return `${d}/${m}/${y}`; }
  function getHora12() {
    const n = new Date();
    let h = n.getHours();
    const m = String(n.getMinutes()).padStart(2, '0');
    const s = String(n.getSeconds()).padStart(2, '0');
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return `${String(h).padStart(2, '0')}:${m}:${s} ${ampm}`;
  }
  
  function getFechaHora() {
    const n = new Date();
    const d = String(n.getDate()).padStart(2, '0');
    const mo = String(n.getMonth() + 1).padStart(2, '0');
    const y = n.getFullYear();
    let h = n.getHours();
    const mi = String(n.getMinutes()).padStart(2, '0');
    const s = String(n.getSeconds()).padStart(2, '0');
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return `${d}/${mo}/${y} ${String(h).padStart(2, '0')}:${mi}:${s} ${ampm}`;
  }

  function guardarDatos() { localStorage.setItem('osrs_tracker_v3', JSON.stringify(state)); }

  async function actualizarTasas() {
    try {
      const r = await fetch('https://open.er-api.com/v6/latest/USD');
      if(r.ok) {
        const d = await r.json();
        const v = parseFloat(d.rates?.VES);
        if(!isNaN(v) && v > 0) {
          state.tasaBCV = v;
          state.timestamps.tasaBCV = getFechaHora();
        }
      }
    } catch(e) {
      console.log('Error BCV:', e);
    }
    try {
      const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=ves');
      if(r.ok) {
        const d = await r.json();
        const u = parseFloat(d.tether?.ves);
        if(!isNaN(u) && u > 0) {
          state.tasaBinance = u;
          state.timestamps.tasaBinance = getFechaHora();
        }
      }
    } catch(e) {
      console.log('Error Binance:', e);
    }
    renderHeaderTasas();
  }

  async function cargarDatos() {
    try {
      const res = await fetch("data.json?t=" + Date.now());
      if (res.ok) {
        const data = await res.json();
        state.farmeo = data.farmeo || [];
        state.objetivos = data.objetivos || [];
        state.pagos = data.pagos || [];
        state.membresia = data.membresia || {};
        state.projectName = data.projectName || state.projectName;
        state.bankActualGP = parseFloat(data.bankActualGP) || 0;
        state.tasaGPUSD = parseFloat(data.tasaGP) || 0.0002;
        state.tasaBCV = parseFloat(data.tasaBCV) || 402.33;
        state.tasaBinance = parseFloat(data.tasaBinance) || 583;
      }
    } catch(e) { console.log('Error cargando data.json'); }
    
    const saved = localStorage.getItem('osrs_tracker_v3');
    if (saved) {
      try {
        const local = JSON.parse(saved);
        if(local.farmeo && Array.isArray(local.farmeo)) state.farmeo = local.farmeo;
        if(local.objetivos && Array.isArray(local.objetivos)) state.objetivos = local.objetivos;
        if(local.pagos && Array.isArray(local.pagos)) state.pagos = local.pagos;
        if(local.membresia && typeof local.membresia === 'object') state.membresia = local.membresia;
        if(local.projectName) state.projectName = local.projectName;
        if(local.bankActualGP !== undefined) state.bankActualGP = parseFloat(local.bankActualGP);
        if(local.tasaGPUSD) state.tasaGPUSD = parseFloat(local.tasaGPUSD);
        if(local.tasaGPBS) state.tasaGPBS = parseFloat(local.tasaGPBS);
        if(local.timestamps) state.timestamps = local.timestamps;
      } catch(e) { console.log('Error leyendo localStorage'); }
    }
    
    if(!state.timestamps) state.timestamps = {};
    if(!state.timestamps.tasaBCV) state.timestamps.tasaBCV = getFechaHora();
    if(!state.timestamps.tasaBinance) state.timestamps.tasaBinance = getFechaHora();
    if(!state.timestamps.tasaGP) state.timestamps.tasaGP = getHora12();
    await actualizarTasas();
  }

  function renderHeaderTasas() {
    const html = `
      <div class="tasa-mini" onclick="abrirModal('modalTasaGP')">
        <div class="tasa-mini-label">m/USD</div>
        <div class="tasa-mini-value">${state.tasaGPUSD.toFixed(5)}</div>
        <div class="tasa-mini-hora">${state.timestamps.tasaGP}</div>
      </div>
      <div class="tasa-mini" onclick="abrirModal('modalTasaGP')">
        <div class="tasa-mini-label">m/Bs</div>
        <div class="tasa-mini-value">${state.tasaGPBS.toFixed(2)}</div>
        <div class="tasa-mini-hora">${state.timestamps.tasaGP}</div>
      </div>
      <div class="tasa-mini">
        <div class="tasa-mini-label">BCV</div>
        <div class="tasa-mini-value">${state.tasaBCV.toFixed(2)}</div>
        <div class="tasa-mini-hora">${state.timestamps.tasaBCV}</div>
      </div>
    `;
    document.getElementById('headerTasas').innerHTML = html;
    document.getElementById('tasaBinanceDisplay').textContent = state.tasaBinance.toFixed(2);
    document.getElementById('tasaBinanceHora').textContent = state.timestamps.tasaBinance;
  }

  function renderBank() {
    const bsTotal = state.bankActualGP * state.tasaGPBS;
    const usdBinance = state.bankActualGP * state.tasaGPUSD;
    const usdBCV = bsTotal / state.tasaBCV;
    document.getElementById('bankGP').textContent = formatGP(state.bankActualGP) + ' m';
    document.getElementById('bankResumen').textContent = 
      `${bsTotal.toLocaleString('es-VE', {maximumFractionDigits:0})} Bs ‚Ä¢ $${usdBinance.toFixed(2)} Binance ‚Ä¢ $${usdBCV.toFixed(2)} BCV`;
  }

  function renderMetas() {
    const grid = document.getElementById('metasGrid');
    grid.innerHTML = '<button class="btn-primary" onclick="abrirModal(\'modalNuevoObjetivo\')" style="width: 100%; margin-bottom: 1rem;">‚ûï Nuevo Objetivo</button>';
    state.objetivos.forEach(obj => {
      let metaGP = obj.meta || 0;
      if (obj.tipo === 'bcv') {
        metaGP = obj.metaUSD / state.tasaGPBS;
      } else if (obj.tipo === 'binance') {
        metaGP = obj.metaUSD / state.tasaGPUSD;
      }
      const pct = Math.min((state.bankActualGP / metaGP) * 100, 100) || 0;
      const div = document.createElement('div');
      div.className = 'objetivo-item';
      div.innerHTML = `
        <div class="objetivo-header"><span class="objetivo-name">${obj.nombre}</span><span>${pct.toFixed(1)}%</span><button class="btn-edit" onclick="editarObjetivo(${obj.id})" style="margin-left:auto;">‚úèÔ∏è</button><button class="btn-delete" onclick="eliminarObjetivo(${obj.id})">üóë</button></div>
        <div class="progress-bar"><div class="progress-fill" style="width: ${pct}%"></div></div>
        <div class="objetivo-values">
          <span>Actual: <strong>${formatGP(state.bankActualGP)}</strong> m</span>
          <span>Meta: <strong>${formatGP(metaGP)}</strong> m</span>
        </div>
      `;
      grid.appendChild(div);
    });
  }

  function renderFarmeo() {
    const inicio = (paginaActualFarmeo - 1) * diasPorPagina;
    const dias = state.farmeo.slice(inicio, inicio + diasPorPagina);
    const tbody = document.getElementById('farmeoBody');
    tbody.innerHTML = '';
    dias.forEach((d, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${inicio + i + 1}</td>
        <td>${formatFecha(d.fecha)}</td>
        <td class="gp-cell">${formatGP(d.gp)} m</td>
        <td>${d.tob || 0}</td>
        <td>${d.notas.includes('[') ? 'üíé' : '‚Äî'}</td>
        <td>${d.notas}</td>
        <td><button class="btn-edit" onclick="editarFarmeo(${d.id})">‚úèÔ∏è</button><button class="btn-delete" onclick="eliminarDia(${d.id})">üóë</button></td>
      `;
      tbody.appendChild(tr);
    });
    actualizarTotales();
    renderGrafica();
    document.getElementById('paginaInfo').textContent = `${paginaActualFarmeo}/${Math.ceil(state.farmeo.length/diasPorPagina) || 1}`;
  }

  function actualizarTotales() {
    let total = 0; state.farmeo.forEach(d => total += d.gp);
    document.getElementById('totalGenerado').textContent = formatGP(total) + ' m';
    document.getElementById('promedioDiario').textContent = formatGP(state.farmeo.length ? total/state.farmeo.length : 0) + ' m';
    document.getElementById('totalDias').textContent = state.farmeo.length;
    document.getElementById('valorBank').textContent = '$' + (total * state.tasaGPUSD).toFixed(2);
  }

  function renderPagos() {
    const tbody = document.getElementById('pagosBody');
    tbody.innerHTML = '';
    state.pagos.forEach(p => {
      const tr = document.createElement('tr');
      const montoBs = p.monto * state.tasaBCV;
      tr.innerHTML = `
        <td>${p.mes}</td>
        <td>${formatFecha(p.fechaLimite)}</td>
        <td>$${p.monto}</td>
        <td>${montoBs.toLocaleString('es-VE')} Bs</td>
        <td><button class="btn-secondary" onclick="togglePago(${p.id})">${p.estado}</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function togglePago(id) {
    const p = state.pagos.find(x => x.id === id);
    if(p) {
      const hoy = new Date();
      const limite = new Date(p.fechaLimite);
      if(p.estado === 'Pendiente') p.estado = (hoy > limite) ? 'Mora' : 'Pagado';
      else if(p.estado === 'Mora') p.estado = 'Pagado';
      else p.estado = 'Pendiente';
      guardarDatos(); renderPagos();
    }
  }

  function renderMembresia() {
    const div = document.getElementById('membresia');
    if(!state.membresia.fechaVencimiento) {
      div.innerHTML = '<button class="btn-primary" onclick="abrirModal(\'modalBond\')">‚ûï Registrar Bond</button>';
      return;
    }
    const vence = new Date(state.membresia.fechaVencimiento);
    const dias = Math.ceil((vence - new Date()) / (1000*60*60*24));
    div.innerHTML = `
      <div class="membresia-card">
        <div class="membresia-value">${dias} d√≠as restantes</div>
        <div class="membresia-label">Vence: ${formatFecha(state.membresia.fechaVencimiento)}</div>
        <button class="btn-secondary" onclick="abrirModal(\'modalBond\')" style="margin-top:0.5rem">Renovar (14 d√≠as)</button>
      </div>
    `;
  }

  function renderGrafica() {
    const ctx = document.getElementById('farmeoChart').getContext('2d');
    if(chartFarmeo) chartFarmeo.destroy();
    const labels = state.farmeo.map(d => formatFecha(d.fecha));
    const dropPoints = state.farmeo.map(d => d.notas.includes('[') ? d.gp : null);
    chartFarmeo = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'GP (m)', data: state.farmeo.map(d => d.gp), backgroundColor: '#d4af37', yAxisID: 'y' },
          { label: 'ToB', data: state.farmeo.map(d => d.tob), backgroundColor: '#8b5cf6', yAxisID: 'y1' },
          { label: 'Drops üíé', data: dropPoints, type: 'scatter', pointRadius: 8, pointBackgroundColor: '#ff6b6b', pointBorderColor: '#fff', pointBorderWidth: 2, yAxisID: 'y' }
        ]
      },
      options: { scales: { y: { position: 'left' }, y1: { position: 'right', grid: { drawOnChartArea: false } } } }
    });
  }

  async function buscarItem() {
    const q = document.getElementById('searchInput').value.trim();
    if(!q || q.length < 2) { document.getElementById('searchResults').innerHTML = ''; return; }
    const res = document.getElementById('searchResults');
    res.innerHTML = 'Buscando en Grand Exchange...';
    try {
      const url = 'https://prices.runescape.wiki/api/v1/osrs/search?q=' + encodeURIComponent(q);
      const proxyUrl = 'https://cdn.jsdelivr.net/gh/jvilk/BrowserFS@master/dist/browserfs.min.js?url=' + encodeURIComponent(url);
      const response = await fetch('https://api.codetabs.com/v1/proxy?q=' + encodeURIComponent(url));
      if(!response.ok) throw new Error('API error');
      const data = await response.json();
      const items = data.items || [];
      if(!items || items.length === 0) { res.innerHTML = '<p style="text-align:center;color:#999;">No se encontraron items tradeables.</p>'; return; }
      res.innerHTML = items.slice(0, 20).map(i => {
        const high = i.high || 0;
        const low = i.low || 0;
        const name = i.name || 'Unknown';
        const margin = high > 0 ? (((high - low) / high) * 100).toFixed(1) : 0;
        const usd = (high / 1000000) * state.tasaGPUSD;
        const bs = (high / 1000000) * state.tasaGPBS;
        return '<div class="item-card" style="border:1px solid #d4af37;padding:10px;margin:5px;border-radius:5px;background:#f9f9f9;"><div class="item-name" style="font-weight:bold;color:#d4af37;">' + name + '</div><div class="item-details" style="margin:5px 0;">üí∞ Compra: ' + formatGP(low/1000000) + ' m</div><div class="item-details" style="margin:5px 0;">üíµ Venta: ' + formatGP(high/1000000) + ' m</div><div class="item-details" style="margin:5px 0;">üìä Margen: ' + margin + '%</div><div class="item-price" style="margin:5px 0;color:#2ecc71;">USD: $' + usd.toFixed(2) + '</div><div class="item-price" style="margin:5px 0;color:#3498db;">Bs: ' + bs.toLocaleString('es-VE', {maximumFractionDigits:0}) + '</div></div>';
      }).join('');
    } catch(e) {
      res.innerHTML = '<p style="text-align:center;color:#ff6b6b;">Error al conectar con Grand Exchange. Intenta de nuevo.</p>';
      console.log('Error b√∫squeda:', e);
    }
  }

  function abrirModal(id) { document.getElementById(id).classList.add('active'); }
  function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }
  function guardarTitulo() { state.projectName = document.getElementById('inputTitulo').value; document.getElementById('projectTitle').textContent = state.projectName; guardarDatos(); cerrarModal('modalTitulo'); }
  function guardarBank() { state.bankActualGP = parseFloat(document.getElementById('inputBankGP').value); renderBank(); renderMetas(); guardarDatos(); cerrarModal('modalBank'); }
  function guardarTasaGP() { 
    state.tasaGPUSD = parseFloat(document.getElementById('inputTasaGPUSD').value);
    state.tasaGPBS = parseFloat(document.getElementById('inputTasaGPBS').value);
    state.timestamps.tasaGP = getHora12();
    renderHeaderTasas(); renderBank(); renderMetas(); guardarDatos(); cerrarModal('modalTasaGP');
  }
  function guardarBond() { const f = document.getElementById('bondFecha').value; const d = parseInt(document.getElementById('bondDias').value) || 14; const v = new Date(new Date(f).getTime() + d*24*60*60*1000).toISOString().split('T')[0]; state.membresia = { fechaCompra: f, fechaVencimiento: v, dias: d }; renderMembresia(); guardarDatos(); cerrarModal('modalBond'); }
  function guardarFarmeo() { 
    const f = document.getElementById('farmeoFecha').value;
    const g = parseFloat(document.getElementById('farmeoGP').value);
    const t = parseInt(document.getElementById('farmeoToB').value) || 0;
    const n = document.getElementById('farmeoNotas').value;
    if(editandoFarmeoId) {
      const item = state.farmeo.find(x => x.id === editandoFarmeoId);
      if(item) { item.fecha = f; item.gp = g; item.tob = t; item.notas = n; }
      editandoFarmeoId = null;
    } else {
      state.farmeo.push({ id: Date.now(), fecha: f, gp: g, tob: t, notas: n });
    }
    state.farmeo.sort((a,b) => new Date(a.fecha) - new Date(b.fecha));
    renderFarmeo(); guardarDatos(); cerrarModal('modalFarmeo');
  }
  function abrirModalFarmeo() {
    editandoFarmeoId = null;
    document.getElementById('modalFarmeoTitle').textContent = 'A√±adir Farmeo';
    document.getElementById('farmeoFecha').value = '';
    document.getElementById('farmeoGP').value = '';
    document.getElementById('farmeoToB').value = '';
    document.getElementById('farmeoNotas').value = '';
    abrirModal('modalFarmeo');
  }
  function editarFarmeo(id) {
    const item = state.farmeo.find(x => x.id === id);
    if(item) {
      editandoFarmeoId = id;
      document.getElementById('modalFarmeoTitle').textContent = 'Editar Farmeo';
      document.getElementById('farmeoFecha').value = item.fecha;
      document.getElementById('farmeoGP').value = item.gp;
      document.getElementById('farmeoToB').value = item.tob;
      document.getElementById('farmeoNotas').value = item.notas;
      abrirModal('modalFarmeo');
    }
  }
  function guardarNuevoObjetivo() {
    const n = document.getElementById('objNombre').value;
    const m = parseFloat(document.getElementById('objMeta').value);
    const t = document.getElementById('objTipo').value;
    const modal = document.getElementById('modalNuevoObjetivo');
    if(modal.dataset.editId) {
      const id = parseInt(modal.dataset.editId);
      const obj = state.objetivos.find(x => x.id === id);
      if(obj) { 
        obj.nombre = n; 
        obj.tipo = t;
        if(t === 'gp') { obj.meta = m; obj.metaUSD = 0; }
        else if(t === 'bcv') { obj.meta = 0; obj.metaUSD = m; obj.tasaUsada = 'bcv'; }
        else if(t === 'binance') { obj.meta = 0; obj.metaUSD = m; obj.tasaUsada = 'binance'; }
      }
      delete modal.dataset.editId;
      document.querySelector('#modalNuevoObjetivo h2').textContent = 'Nuevo Objetivo';
    } else {
      const newObj = { id: Date.now(), nombre: n, tipo: t };
      if(t === 'gp') { newObj.meta = m; newObj.metaUSD = 0; }
      else if(t === 'bcv') { newObj.meta = 0; newObj.metaUSD = m; newObj.tasaUsada = 'bcv'; }
      else if(t === 'binance') { newObj.meta = 0; newObj.metaUSD = m; newObj.tasaUsada = 'binance'; }
      state.objetivos.push(newObj);
    }
    renderMetas(); guardarDatos(); cerrarModal('modalNuevoObjetivo');
  }
  function editarObjetivo(id) {
    const obj = state.objetivos.find(x => x.id === id);
    if(obj) {
      document.getElementById('objNombre').value = obj.nombre;
      document.getElementById('objMeta').value = obj.meta || obj.metaUSD;
      document.getElementById('objTipo').value = obj.tipo;
      document.querySelector('#modalNuevoObjetivo h2').textContent = 'Editar Objetivo';
      document.getElementById('modalNuevoObjetivo').dataset.editId = id;
      abrirModal('modalNuevoObjetivo');
    }
  }
  function eliminarObjetivo(id) {
    if(confirm('¬øEst√°s seguro de que quieres eliminar este objetivo?')) {
      state.objetivos = state.objetivos.filter(x => x.id !== id);
      renderMetas(); guardarDatos();
    }
  }

  function eliminarDia(id) { state.farmeo = state.farmeo.filter(x => x.id !== id); renderFarmeo(); guardarDatos(); }
  function paginaAnterior() { if(paginaActualFarmeo > 1) { paginaActualFarmeo--; renderFarmeo(); } }
  function paginaSiguiente() { if(paginaActualFarmeo < Math.ceil(state.farmeo.length/diasPorPagina)) { paginaActualFarmeo++; renderFarmeo(); } }

  async function init() {
    await cargarDatos();
    document.getElementById('projectTitle').textContent = state.projectName;
    document.getElementById('inputTitulo').value = state.projectName;
    document.getElementById('inputBankGP').value = state.bankActualGP;
    document.getElementById('inputTasaGPUSD').value = state.tasaGPUSD;
    document.getElementById('inputTasaGPBS').value = state.tasaGPBS;
    renderHeaderTasas(); renderBank(); renderFarmeo(); renderMetas(); renderPagos(); renderMembresia();
    setInterval(() => { document.getElementById('relojActual').textContent = getHora12(); }, 1000);
  }
  init();
</script>
</body>
</html>
