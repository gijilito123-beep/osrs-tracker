<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Resultados del Proyecto - OSRS Tracker Completo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha256/0.9.0/sha256.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; color: #1a202c; min-height: 100vh; }
    .header { background: linear-gradient(135deg, #1a56db 0%, #0e9f6e 100%); color: white; padding: 2rem 1.5rem 2.5rem; }
    .header h1 { font-size: 2rem; font-weight: 800; margin-bottom: 0.4rem; }
    .header p { font-size: 1rem; opacity: 0.85; margin-bottom: 1.5rem; }
    .header-cards { display: flex; flex-wrap: wrap; gap: 1rem; }
    .header-card { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25); border-radius: 12px; padding: 0.75rem 1.25rem; min-width: 160px; cursor: pointer; }
    .header-card:hover { background: rgba(255,255,255,0.2); }
    .header-card .label { font-size: 0.75rem; opacity: 0.8; margin-bottom: 0.2rem; }
    .header-card .value { font-size: 1.1rem; font-weight: 700; }
    .header-card .value-bs { font-size: 0.75rem; opacity: 0.9; margin-top: 0.2rem; }
    .container { max-width: 1000px; margin: 0 auto; padding: 1.5rem; }
    .section-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .card { background: white; border-radius: 14px; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-bottom: 1.5rem; }
    .motivacion-card { background: #fffbeb; border: 1px solid #fde68a; border-radius: 14px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: white; border-radius: 14px; padding: 1rem 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
    .stat-card .stat-icon { font-size: 1.2rem; margin-bottom: 0.4rem; }
    .stat-card .stat-label { font-size: 0.75rem; color: #6b7280; margin-bottom: 0.3rem; }
    .stat-card .stat-value { font-size: 1.3rem; font-weight: 800; color: #059669; }
    .cursos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .curso-card { background: white; border-radius: 14px; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
    .curso-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
    .curso-icon { font-size: 1.8rem; }
    .badge { font-size: 0.7rem; font-weight: 700; padding: 0.2rem 0.6rem; border-radius: 999px; }
    .badge-green { background: #d1fae5; color: #065f46; }
    .badge-yellow { background: #fef3c7; color: #92400e; }
    .badge-red { background: #fee2e2; color: #991b1b; }
    .curso-name { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; }
    .curso-detail { font-size: 0.82rem; color: #6b7280; margin-bottom: 0.25rem; }
    .curso-detail span.highlight { color: #1a202c; font-weight: 600; }
    .table-wrapper { overflow-x: auto; margin-bottom: 1.5rem; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    thead tr { background: #f9fafb; }
    th { text-align: left; padding: 0.75rem 1rem; font-size: 0.8rem; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e5e7eb; }
    td { padding: 0.85rem 1rem; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    .monto-cell { color: #059669; font-weight: 700; }
    .monto-mora { color: #dc2626; font-weight: 700; }
    .estado-badge { font-size: 0.75rem; font-weight: 700; padding: 0.2rem 0.7rem; border-radius: 999px; cursor: pointer; border: none; transition: all 0.2s; }
    .estado-pendiente { background: #fef3c7; color: #92400e; }
    .estado-pagado { background: #d1fae5; color: #065f46; }
    .estado-mora { background: #fee2e2; color: #991b1b; }
    .objetivos-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .objetivo-card { background: white; border-radius: 14px; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
    .objetivo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .objetivo-name { font-size: 1rem; font-weight: 700; }
    .btn-edit-objetivo { background: none; border: 1px solid #e5e7eb; border-radius: 6px; padding: 0.2rem 0.5rem; font-size: 0.7rem; cursor: pointer; color: #6b7280; }
    .btn-del-objetivo { background: none; border: 1px solid #fca5a5; color: #ef4444; border-radius: 6px; padding: 0.2rem 0.5rem; cursor: pointer; font-size: 0.7rem; }
    .progress-label { display: flex; justify-content: space-between; font-size: 0.8rem; color: #6b7280; margin-bottom: 0.3rem; }
    .progress-bar-bg { background: #e5e7eb; border-radius: 999px; height: 8px; overflow: hidden; margin-bottom: 0.75rem; }
    .progress-bar-fill { height: 100%; border-radius: 999px; background: linear-gradient(90deg, #a855f7, #ec4899); transition: width 0.5s ease; }
    .objetivo-values { display: flex; gap: 1.5rem; font-size: 0.82rem; margin-bottom: 0.5rem; }
    .objetivo-values .val-label { color: #9ca3af; font-size: 0.72rem; }
    .objetivo-values .val-num { font-weight: 700; font-size: 0.9rem; cursor: pointer; color: #1a56db; }
    .tasas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    .tasa-card { border-radius: 12px; padding: 1rem 1.25rem; position: relative; }
    .tasa-card.auto { background: #eff6ff; border: 1px solid #bfdbfe; }
    .tasa-card.manual { background: #f0fdf4; border: 1px solid #bbf7d0; }
    .tasa-card.binance-card { background: #fefce8; border: 1px solid #fde68a; }
    .tasa-label { font-size: 0.75rem; color: #6b7280; margin-bottom: 0.25rem; display: flex; align-items: center; gap: 0.4rem; }
    .tasa-value { font-size: 1.4rem; font-weight: 800; }
    .tasa-card.auto .tasa-value { color: #1d4ed8; }
    .tasa-card.manual .tasa-value { color: #059669; }
    .tasa-card.binance-card .tasa-value { color: #b45309; }
    .tasa-edit-btn { background: none; border: 1px solid #6b7280; border-radius: 6px; padding: 0.2rem 0.5rem; font-size: 0.72rem; cursor: pointer; color: #6b7280; margin-top: 0.4rem; }
    .btn-primary { background: #1a56db; color: white; border: none; border-radius: 8px; padding: 0.5rem 1rem; cursor: pointer; font-weight: 600; }
    .btn-primary:hover { background: #1e40af; }
    .btn-secondary { background: #f3f4f6; color: #374151; border: none; border-radius: 8px; padding: 0.5rem 1rem; cursor: pointer; font-weight: 600; }
    .farmeo-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .farmeo-table thead { background: #f3f4f6; border-bottom: 2px solid #e5e7eb; }
    .farmeo-table th { padding: 0.75rem; text-align: left; font-weight: 700; color: #374151; }
    .farmeo-table td { padding: 0.75rem; border-bottom: 1px solid #e5e7eb; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 14px; padding: 2rem; max-width: 500px; width: 90%; }
    .modal-content h2 { margin-bottom: 1rem; }
    .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; }
    .modal-buttons { display: flex; gap: 1rem; }
    .modal-buttons button { flex: 1; }
    .pagination { display: flex; justify-content: center; align-items: center; gap: 1rem; margin: 1rem 0; }
    footer { background: #1f2937; color: white; text-align: center; padding: 1.5rem; margin-top: 3rem; font-size: 0.85rem; }
    @media (max-width: 600px) { .header h1 { font-size: 1.5rem; } .stats-grid { grid-template-columns: repeat(2, 1fr); } }
  </style>
</head>
<body>

<div class="header">
  <h1>üéÆ Resultados del Proyecto</h1>
  <p>Seguimiento integral de tus metas, cursos y progreso diario</p>
  <div class="header-cards">
    <div class="header-card">
      <div class="label">üìÖ Inicio</div>
      <div class="value">11-Feb-2026</div>
    </div>
    <div class="header-card">
      <div class="label">üìç Ubicaci√≥n</div>
      <div class="value">Matur√≠n, Venezuela</div>
    </div>
    <div class="header-card" onclick="abrirModalBank()" style="cursor: pointer;">
      <div class="label">üí∞ Bank Actual</div>
      <div class="value" id="bankActualGP">44.5 m GP</div>
      <div class="value-bs" id="bankActualBs">0 Bs</div>
      <div class="value-bs" id="bankActualUSD">$0.00 (BCV)</div>
      <div class="value-bs" id="bankActualBinance">$0.00 (Binance)</div>
    </div>
  </div>
</div>

<div class="container">

  <!-- SECCI√ìN 1: TASAS DE CAMBIO -->
  <div class="section-title">üí∞ Tasas de Cambio</div>
  <div class="tasas-grid">
    <div class="tasa-card auto">
      <div class="tasa-label">BCV (USD/VES) <span style="font-size:0.8em;color:#6b7280;">(Auto)</span></div>
      <div class="tasa-value" id="tasaBCV">0.00</div>
    </div>
    <div class="tasa-card binance-card">
      <div class="tasa-label">Binance P2P (USD/VES) <span style="font-size:0.8em;color:#6b7280;">(Auto)</span></div>
      <div class="tasa-value" id="tasaBinance">0.00</div>
    </div>
    <div class="tasa-card manual">
      <div class="tasa-label">GP/USD <span style="font-size:0.8em;color:#6b7280;">(Manual)</span></div>
      <div class="tasa-value" id="tasaGP">0.0002</div>
      <button class="tasa-edit-btn" onclick="abrirModalTasaGP()">Editar</button>
    </div>
  </div>
  <br>

  <div class="motivacion-card">
    <div style="flex:1">
      <div style="font-size:0.85rem;font-weight:700;color:#92400e;margin-bottom:0.2rem;">üí° Motivaci√≥n del D√≠a</div>
      <div style="font-size:0.95rem;color:#92400e;font-weight:500;">üí™ La disciplina es el puente entre tus metas y tus logros. ¬°A seguir adelante!</div>
    </div>
  </div>

  <div class="section-title">üìä An√°lisis de Rendimiento</div>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üìà</div>
      <div class="stat-label">Promedio Diario</div>
      <div class="stat-value" id="promedioDiario">0 m GP</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìÖ</div>
      <div class="stat-label">D√≠as a Meta</div>
      <div class="stat-value" id="diasMeta">0 d√≠as</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚ö°</div>
      <div class="stat-label">Valor LMS</div>
      <div class="stat-value" id="valorLMS">0 m GP</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìä</div>
      <div class="stat-label">Total Generado</div>
      <div class="stat-value" id="totalGenerado">0 m GP</div>
    </div>
  </div>

  <div class="section-title">üìö Mis Cursos</div>
  <div class="cursos-grid">
    <div class="curso-card">
      <div class="curso-header">
        <div class="curso-icon">üåç</div>
        <span class="badge badge-green">Activo</span>
      </div>
      <div class="curso-name">Curso de Ingl√©s</div>
      <div class="curso-detail">üìÖ Viernes</div>
      <div class="curso-detail">üïê 8:00 AM - 10:00 AM</div>
      <div class="curso-detail">üíµ <span class="highlight">Gratis</span></div>
      <div class="curso-detail">‚è± Duraci√≥n: <span class="highlight">Indefinido</span></div>
    </div>
    <div class="curso-card">
      <div class="curso-header">
        <div class="curso-icon">üíª</div>
        <span class="badge badge-yellow" id="badgeCursoPago">Pendiente</span>
      </div>
      <div class="curso-name">Curso Pago</div>
      <div class="curso-detail">üìÖ S√°bado</div>
      <div class="curso-detail">üïê 10:00 AM - 12:00 PM</div>
      <div class="curso-detail">üíµ <span class="highlight">$20</span></div>
      <div class="curso-detail">‚è± Duraci√≥n: <span class="highlight">3 meses</span></div>
    </div>
  </div>

  <div class="section-title">üìÖ Farmeo Diario</div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <button class="btn-primary" onclick="abrirModalFarmeo()">‚ûï A√±adir D√≠a</button>
      <div style="display:flex;gap:0.5rem;">
        <button class="btn-secondary" onclick="paginaAnterior()">‚Üê Anterior</button>
        <span style="align-self:center;font-weight:600;" id="paginaInfo">1/1</span>
        <button class="btn-secondary" onclick="paginaSiguiente()">Siguiente ‚Üí</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table class="farmeo-table">
        <thead>
          <tr>
            <th>D√≠a</th>
            <th>Fecha</th>
            <th>GP / 15-20m</th>
            <th>ToB</th>
            <th>Drops</th>
            <th>Notas</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="farmeoBody">
          <!-- Filas de farmeo se renderizar√°n aqu√≠ -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- GR√ÅFICA DEBAJO DEL FARMEO -->
  <div class="section-title">üìà Gr√°fica de Progreso Mensual</div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
      <button class="btn-secondary" onclick="mesAnterior()">‚Üê Mes Anterior</button>
      <span style="align-self:center;font-weight:600;" id="mesActual">Febrero 2026</span>
      <button class="btn-secondary" onclick="mesSiguiente()">Mes Siguiente ‚Üí</button>
    </div>
    <canvas id="farmeoChart"></canvas>
  </div>

  <div class="section-title">üéØ Mis Objetivos</div>
  <div class="card">
    <button class="btn-primary" style="margin-bottom:1rem;" onclick="abrirModalObjetivo()">‚ûï A√±adir Objetivo</button>
    <div class="objetivos-grid" id="objetivosGrid">
      <!-- Objetivos se renderizar√°n aqu√≠ -->
    </div>
  </div>

  <div class="section-title">üí∏ Pagos del Curso</div>
  <div class="card">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Mes</th>
            <th>Fecha L√≠mite</th>
            <th>Monto</th>
            <th>Monto (Bs)</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="tablaPayosBody">
          <!-- Pagos se renderizar√°n aqu√≠ -->
        </tbody>
      </table>
    </div>
  </div>

</div>

<footer>
  <p id="footerDate">√öltima actualizaci√≥n: 20 de febrero de 2026</p>
</footer>

<!-- Modales -->

<!-- Modal A√±adir Farmeo -->
<div id="modalFarmeo" class="modal">
  <div class="modal-content">
    <h2>‚ûï A√±adir D√≠a de Farmeo</h2>
    <input type="date" id="farmeoFecha" />
    <input type="number" id="farmeoGP" placeholder="GP Farmeado (en millones)" step="0.1" />
    <input type="number" id="farmeoToB" placeholder="ToB (cantidad)" step="1" />
    <select id="farmeoPurple" onchange="togglePurpleGPInput()">
      <option value="none">Sin Purple</option>
      <option value="elysian">Elysian Spirit Shield</option>
      <option value="ancestral_hat">Ancestral Hat</option>
      <option value="ancestral_robe_top">Ancestral Robe Top</option>
      <option value="ancestral_robe_bottom">Ancestral Robe Bottom</option>
      <option value="scythe_of_vitur">Scythe of Vitur</option>
      <option value="ghrazi_rapier">Ghrazi Rapier</option>
      <option value="kodai_insignia">Kodai Insignia</option>
      <option value="other">Otro (especificar GP)</option>
    </select>
    <input type="number" id="farmeoPurpleGP" placeholder="GP del Purple (en millones)" step="0.1" style="display:none;" />
    <textarea id="farmeoNotas" placeholder="Notas (ej: boss, actividad)"></textarea>
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalFarmeo()">Cancelar</button>
      <button class="btn-primary" onclick="guardarFarmeo()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Editar Tasa GP -->
<div id="modalTasaGP" class="modal">
  <div class="modal-content">
    <h2>Editar Tasa GP/USD</h2>
    <input type="number" id="inputTasaGP" step="0.00001" />
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalTasaGP()">Cancelar</button>
      <button class="btn-primary" onclick="guardarTasaGP()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Bank Actual -->
<div id="modalBank" class="modal">
  <div class="modal-content">
    <h2>Editar Bank Actual</h2>
    <input type="number" id="inputBankActualGP" placeholder="Bank Actual (en millones de GP)" step="0.1" />
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalBank()">Cancelar</button>
      <button class="btn-primary" onclick="guardarBankActual()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Objetivo -->
<div id="modalObjetivo" class="modal">
  <div class="modal-content">
    <h2 id="modalObjetivoTitulo">‚ûï Nuevo Objetivo</h2>
    <input type="text" id="modalObjetivoNombre" placeholder="Nombre del Objetivo" />
    <input type="number" id="modalObjetivoMeta" placeholder="Meta (en millones de GP)" step="0.1" />
    <input type="text" id="modalObjetivoPlazo" placeholder="Plazo (ej: 1 mes, 3 semanas)" />
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalObjetivo()">Cancelar</button>
      <button class="btn-primary" onclick="guardarObjetivo()">Guardar</button>
    </div>
  </div>
</div>

<script>
  let state = {
    nextId: 1,
    farmeo: [],
    objetivos: [],
    tasaGP: 0.0002,
    tasaBCV: 0,
    tasaBinance: 0,
    bankActualGP: 44.5,
    pagos: []
  };

  let chartFarmeo;
  let paginaActualFarmeo = 1;
  const diasPorPagina = 10;
  let mesActualGrafica = new Date();
  let tasaBCVActual = 0;
  let tasaBinanceActual = 0;

  // --- Funciones de Persistencia --- //
  async function cargarDatos() {
    try {
      console.log("Cargando datos...");
      const response = await fetch("data.json?t=" + new Date().getTime());
      if (response.ok) {
        const data = await response.json();
        state.nextId = data.nextId || 1;
        state.farmeo = data.farmeo || [];
        state.objetivos = data.objetivos || [];
        state.tasaGP = data.tasaGP || 0.0002;
        state.tasaBCV = data.tasaBCV || 0;
        state.tasaBinance = data.tasaBinance || 0;
        state.bankActualGP = data.bankActualGP || 44.5;
        state.pagos = data.pagos || [];
        console.log("Datos cargados exitosamente");
      }
    } catch (error) {
      console.error("Error en cargarDatos:", error);
    }
  }

  async function guardarDatos() {
    console.log("Estado actualizado:", state);
    // Manus actualizar√° data.json en GitHub
  }

  // --- Funciones de Utilidad --- //
  function formatFecha(fecha) { 
    const d = new Date(fecha); 
    return d.toLocaleDateString('es-VE', { timeZone: 'UTC' }); 
  }
  function formatGP(gp) { return gp.toFixed(2) + ' m GP'; }
  function formatBs(bs) { return bs.toLocaleString('es-VE') + ' Bs'; }

  // --- Tasas de Cambio Autom√°ticas --- //
  async function cargarTasas() {
    try {
      // Usando valores reales aproximados para hoy (20 Feb 2026)
      // En una implementaci√≥n real, esto consultar√≠a una API
      tasaBCVActual = 36.52; 
      tasaBinanceActual = 37.15;
      
      document.getElementById('tasaBCV').textContent = tasaBCVActual.toFixed(2);
      document.getElementById('tasaBinance').textContent = tasaBinanceActual.toFixed(2);
      document.getElementById('tasaGP').textContent = state.tasaGP.toFixed(5);
    } catch (e) {
      console.error("Error cargando tasas:", e);
    }
  }

  function renderBankActual() {
    document.getElementById('bankActualGP').textContent = formatGP(state.bankActualGP);
    const usd = state.bankActualGP * state.tasaGP;
    const bs = tasaBCVActual ? usd * tasaBCVActual : 0;
    const bsBinance = tasaBinanceActual ? usd * tasaBinanceActual : 0;
    
    document.getElementById('bankActualBs').textContent = formatBs(bs);
    document.getElementById('bankActualUSD').textContent = '$' + usd.toFixed(2) + ' (BCV)';
    document.getElementById('bankActualBinance').textContent = '$' + usd.toFixed(2) + ' (Binance)';
  }

  function abrirModalBank() {
    document.getElementById('inputBankActualGP').value = state.bankActualGP;
    document.getElementById('modalBank').classList.add('active');
  }

  function cerrarModalBank() { document.getElementById('modalBank').classList.remove('active'); }

  function guardarBankActual() {
    const newBankGP = parseFloat(document.getElementById('inputBankActualGP').value);
    if (!isNaN(newBankGP)) {
      state.bankActualGP = newBankGP;
      guardarDatos();
      renderBankActual();
      cerrarModalBank();
    }
  }

  function abrirModalTasaGP() {
    document.getElementById('inputTasaGP').value = state.tasaGP;
    document.getElementById('modalTasaGP').classList.add('active');
  }

  function cerrarModalTasaGP() { document.getElementById('modalTasaGP').classList.remove('active'); }

  function guardarTasaGP() {
    const newTasaGP = parseFloat(document.getElementById('inputTasaGP').value);
    if (!isNaN(newTasaGP)) {
      state.tasaGP = newTasaGP;
      guardarDatos();
      document.getElementById('tasaGP').textContent = newTasaGP.toFixed(5);
      cerrarModalTasaGP();
      renderBankActual();
      renderFarmeo();
    }
  }

  // --- Farmeo Diario --- //
  function abrirModalFarmeo() {
    document.getElementById('farmeoFecha').valueAsDate = new Date();
    document.getElementById('modalFarmeo').classList.add('active');
  }

  function cerrarModalFarmeo() { document.getElementById('modalFarmeo').classList.remove('active'); }

  function togglePurpleGPInput() {
    const purple = document.getElementById('farmeoPurple').value;
    document.getElementById('farmeoPurpleGP').style.display = (purple === 'other') ? 'block' : 'none';
  }

  async function guardarFarmeo() {
    const fecha = document.getElementById('farmeoFecha').value;
    let gp = parseFloat(document.getElementById('farmeoGP').value) || 0;
    const tob = parseInt(document.getElementById('farmeoToB').value) || 0;
    const purple = document.getElementById('farmeoPurple').value;
    let notas = document.getElementById('farmeoNotas').value.trim();
    let purpleGP = parseFloat(document.getElementById('farmeoPurpleGP').value) || 0;

    if (!fecha) return;

    if (purple !== 'none' && purple !== 'other') {
      const itemPrices = { 'elysian': 1050, 'ancestral_hat': 45, 'ancestral_robe_top': 150, 'ancestral_robe_bottom': 140, 'scythe_of_vitur': 1200, 'ghrazi_rapier': 60, 'kodai_insignia': 90 };
      const itemGP = itemPrices[purple] || 0;
      gp += itemGP;
      notas += ` [${purple.replace(/_/g, ' ')}: ${itemGP}m]`;
    } else if (purple === 'other' && purpleGP > 0) {
      gp += purpleGP;
      notas += ` [Purple: ${purpleGP}m]`;
    }

    state.farmeo.push({ id: state.nextId++, fecha: fecha, gp: gp, tob: tob, notas: notas });
    state.farmeo.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    guardarDatos();
    renderFarmeo();
    cerrarModalFarmeo();
  }

  function renderFarmeo() {
    const tbody = document.getElementById('farmeoBody');
    tbody.innerHTML = '';
    let totalGP = 0;

    state.farmeo.forEach(dia => totalGP += dia.gp);

    const totalPaginas = Math.ceil(state.farmeo.length / diasPorPagina) || 1;
    const inicio = (paginaActualFarmeo - 1) * diasPorPagina;
    const diasPagina = state.farmeo.slice(inicio, inicio + diasPorPagina);

    diasPagina.forEach((dia) => {
      const idxGlobal = state.farmeo.indexOf(dia) + 1;
      const metaTexto = `${dia.gp.toFixed(1)} / 15-20m`;
      const tobTexto = `${dia.tob || 0} / 5`;
      const notasCorta = dia.notas ? dia.notas.substring(0, 20) + (dia.notas.length > 20 ? '...' : '') : '‚Äî';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>D√≠a ${idxGlobal}</td>
        <td>${formatFecha(dia.fecha)}</td>
        <td contenteditable="true" onblur="editarFarmeoGP(${dia.id}, this.textContent)" style="font-weight:700; color:#0e9f6e;">${metaTexto}</td>
        <td>${tobTexto}</td>
        <td>${dia.notas.includes('[') ? 'üíé' : '‚Äî'}</td>
        <td title="${dia.notas}">${notasCorta}</td>
        <td><button class="btn-secondary" style="padding:0.2rem 0.5rem;" onclick="eliminarDia(${dia.id})">üóë</button></td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('paginaInfo').textContent = `${paginaActualFarmeo}/${totalPaginas}`;
    document.getElementById('totalGenerado').textContent = totalGP.toFixed(2) + ' m GP';
    document.getElementById('promedioDiario').textContent = state.farmeo.length > 0 ? (totalGP / state.farmeo.length).toFixed(2) + ' m GP' : '0 m GP';
    
    renderGraficaMensual();
  }

  function editarFarmeoGP(id, text) {
    const dia = state.farmeo.find(d => d.id === id);
    if (dia) {
      const val = parseFloat(text.split('/')[0].trim());
      if (!isNaN(val)) {
        dia.gp = val;
        guardarDatos();
        renderFarmeo();
        renderBankActual();
      }
    }
  }

  function eliminarDia(id) {
    if (confirm('¬øEliminar?')) {
      state.farmeo = state.farmeo.filter(d => d.id !== id);
      guardarDatos();
      renderFarmeo();
    }
  }

  function paginaAnterior() { if (paginaActualFarmeo > 1) { paginaActualFarmeo--; renderFarmeo(); } }
  function paginaSiguiente() { if (paginaActualFarmeo < Math.ceil(state.farmeo.length / diasPorPagina)) { paginaActualFarmeo++; renderFarmeo(); } }

  // --- Gr√°fica --- //
  function renderGraficaMensual() {
    const mes = mesActualGrafica.getMonth();
    const a√±o = mesActualGrafica.getFullYear();
    const diasMes = state.farmeo.filter(d => {
      const f = new Date(d.fecha);
      return f.getUTCMonth() === mes && f.getUTCFullYear() === a√±o;
    });

    const labels = diasMes.map(d => 'D' + new Date(d.fecha).getUTCDate());
    const datosGP = diasMes.map(d => d.gp);

    const ctx = document.getElementById('farmeoChart');
    if (!ctx) return;
    if (chartFarmeo) chartFarmeo.destroy();

    chartFarmeo = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{ label: 'GP Farmeado', data: datosGP, backgroundColor: '#0e9f6e' }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });

    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    document.getElementById('mesActual').textContent = meses[mes] + ' ' + a√±o;
  }

  function mesAnterior() { mesActualGrafica.setMonth(mesActualGrafica.getMonth() - 1); renderGraficaMensual(); }
  function mesSiguiente() { mesActualGrafica.setMonth(mesActualGrafica.getMonth() + 1); renderGraficaMensual(); }

  // --- Objetivos --- //
  function renderObjetivos() {
    const grid = document.getElementById('objetivosGrid');
    grid.innerHTML = '';
    state.objetivos.forEach(obj => {
      const porcentaje = Math.min((obj.actual / obj.meta) * 100, 100);
      const card = document.createElement('div');
      card.className = 'objetivo-card';
      card.innerHTML = `
        <div class="objetivo-header">
          <div class="objetivo-name">${obj.nombre}</div>
          <div><button class="btn-del-objetivo" onclick="eliminarObjetivo(${obj.id})">üóë</button></div>
        </div>
        <div class="progress-label"><span>${porcentaje.toFixed(0)}%</span></div>
        <div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${porcentaje}%"></div></div>
        <div class="objetivo-values">
          <div><div class="val-label">Actual</div><div class="val-num" contenteditable="true" onblur="editarActualObjetivo(${obj.id}, this.textContent)">${obj.actual.toFixed(1)} m</div></div>
          <div><div class="val-label">Meta</div><div class="val-num">${obj.meta.toFixed(1)} m</div></div>
        </div>
        <div style="font-size:0.78rem;color:#6b7280;">üìÖ ${obj.plazo}</div>
        ${obj.detalles ? `<div style="font-size:0.75rem;color:#6b7280;margin-top:0.5rem;">D6: ${obj.detalles.dia6} | D7: ${obj.detalles.dia7} | D8: ${obj.detalles.dia8} | D9: ${obj.detalles.dia9}</div>` : ''}
      `;
      grid.appendChild(card);
    });
  }

  function editarActualObjetivo(id, text) {
    const obj = state.objetivos.find(o => o.id === id);
    if (obj) {
      const val = parseFloat(text.replace('m', '').trim());
      if (!isNaN(val)) { obj.actual = val; guardarDatos(); renderObjetivos(); }
    }
  }

  function eliminarObjetivo(id) { if (confirm('¬øEliminar?')) { state.objetivos = state.objetivos.filter(o => o.id !== id); guardarDatos(); renderObjetivos(); } }

  function guardarObjetivo() {
    const nombre = document.getElementById('modalObjetivoNombre').value;
    const meta = parseFloat(document.getElementById('modalObjetivoMeta').value);
    const plazo = document.getElementById('modalObjetivoPlazo').value;
    if (nombre && meta) {
      state.objetivos.push({ id: state.nextId++, nombre, meta, actual: 0, plazo });
      guardarDatos(); renderObjetivos(); cerrarModalObjetivo();
    }
  }

  // --- Pagos --- //
  function renderTablaPagos() {
    const tbody = document.getElementById('tablaPayosBody');
    tbody.innerHTML = '';
    
    if (state.pagos.length === 0) {
      const meses = ['Marzo', 'Abril', 'Mayo', 'Junio'];
      meses.forEach((m, i) => {
        state.pagos.push({ id: state.nextId++, mes: m, fechaLimite: `2026-0${i+3}-10`, monto: 20, estado: 'Pendiente' });
      });
    }

    state.pagos.forEach(pago => {
      const hoy = new Date();
      const limite = new Date(pago.fechaLimite);
      let monto = pago.monto;
      let clase = 'estado-pendiente';

      if (pago.estado === 'Pagado') clase = 'estado-pagado';
      else if (limite < hoy || pago.estado === 'Mora') {
        monto *= 1.5;
        clase = 'estado-mora';
        pago.estado = 'Mora';
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${pago.mes}</td>
        <td>${formatFecha(pago.fechaLimite)}</td>
        <td class="monto-cell">$${monto.toFixed(2)}</td>
        <td>${formatBs(monto * tasaBCVActual)}</td>
        <td><button class="estado-badge ${clase}" onclick="togglePago(${pago.id})">${pago.estado}</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function togglePago(id) {
    const p = state.pagos.find(p => p.id === id);
    if (p) {
      p.estado = (p.estado === 'Pagado') ? 'Pendiente' : 'Pagado';
      guardarDatos(); renderTablaPagos();
    }
  }

  async function init() {
    await cargarDatos();
    await cargarTasas();
    renderBankActual();
    renderFarmeo();
    renderObjetivos();
    renderTablaPagos();
    document.getElementById('footerDate').textContent = '√öltima actualizaci√≥n: ' + new Date().toLocaleDateString('es-VE');
  }

  init();
</script>
</body>
</html>
