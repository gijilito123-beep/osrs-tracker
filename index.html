<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OSRS Tracker - Farmeo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; color: #1a202c; min-height: 100vh; }
    .header { background: linear-gradient(135deg, #1a56db 0%, #0e9f6e 100%); color: white; padding: 1.5rem; }
    .header h1 { font-size: 1.8rem; font-weight: 800; margin-bottom: 0.3rem; }
    .header p { font-size: 0.9rem; opacity: 0.9; margin-bottom: 1rem; }
    .header-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.8rem; }
    .info-card { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 0.7rem 1rem; font-size: 0.85rem; }
    .info-label { opacity: 0.8; margin-bottom: 0.2rem; font-size: 0.75rem; }
    .info-value { font-weight: 700; font-size: 0.95rem; }
    .info-sub { opacity: 0.75; font-size: 0.7rem; margin-top: 0.1rem; }
    .container { max-width: 1100px; margin: 0 auto; padding: 1rem; }
    .section-title { font-size: 1.1rem; font-weight: 700; margin: 1.5rem 0 0.8rem 0; }
    .card { background: white; border-radius: 10px; padding: 1.2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 1.5rem; }
    .tasas-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .tasa-card { border-radius: 10px; padding: 1rem; border: 2px solid; }
    .tasa-card.bcv { background: #eff6ff; border-color: #1d4ed8; }
    .tasa-card.binance { background: #fefce8; border-color: #b45309; }
    .tasa-card.gp { background: #f0fdf4; border-color: #059669; }
    .tasa-label { font-size: 0.75rem; color: #6b7280; margin-bottom: 0.3rem; font-weight: 600; }
    .tasa-value { font-size: 1.6rem; font-weight: 800; margin-bottom: 0.3rem; }
    .tasa-card.bcv .tasa-value { color: #1d4ed8; }
    .tasa-card.binance .tasa-value { color: #b45309; }
    .tasa-card.gp .tasa-value { color: #059669; }
    .btn-edit { background: #f3f4f6; border: 1px solid #d1d5db; color: #374151; padding: 0.35rem 0.7rem; border-radius: 5px; cursor: pointer; font-size: 0.75rem; font-weight: 600; }
    .btn-edit:hover { background: #e5e7eb; }
    .btn-primary { background: #1a56db; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; }
    .btn-primary:hover { background: #1e40af; }
    .btn-secondary { background: #f3f4f6; color: #374151; border: none; padding: 0.5rem 0.9rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.8rem; margin-bottom: 1.2rem; }
    .stat-card { background: white; border-radius: 8px; padding: 0.9rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); text-align: center; }
    .stat-icon { font-size: 1.3rem; margin-bottom: 0.2rem; }
    .stat-label { font-size: 0.7rem; color: #6b7280; margin-bottom: 0.2rem; }
    .stat-value { font-size: 1rem; font-weight: 800; color: #059669; }
    .table-wrapper { overflow-x: auto; max-height: 500px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { background: #f3f4f6; padding: 0.7rem; text-align: left; font-weight: 700; color: #374151; border-bottom: 2px solid #e5e7eb; position: sticky; top: 0; }
    td { padding: 0.7rem; border-bottom: 1px solid #f3f4f6; }
    tr:hover { background: #f9fafb; }
    .gp-cell { color: #0e9f6e; font-weight: 700; cursor: pointer; padding: 0.3rem 0.5rem; border-radius: 4px; }
    .gp-cell:hover { background: #f0fdf4; }
    .btn-delete { background: #fee2e2; color: #991b1b; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: 600; }
    .btn-delete:hover { background: #fecaca; }
    .pagination { display: flex; gap: 0.5rem; align-items: center; justify-content: center; margin-top: 1rem; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background: white; border-radius: 10px; padding: 1.5rem; max-width: 420px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-content h2 { margin-bottom: 1rem; font-size: 1.1rem; }
    .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 0.6rem; margin-bottom: 0.8rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; }
    .modal-buttons { display: flex; gap: 0.8rem; }
    .modal-buttons button { flex: 1; padding: 0.6rem; }
    .chart-container { position: relative; height: 280px; margin-top: 1rem; }
    .objetivo-item { background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 0.8rem; }
    .objetivo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .objetivo-name { font-weight: 700; }
    .progress-bar { background: #e5e7eb; height: 6px; border-radius: 999px; overflow: hidden; margin-bottom: 0.5rem; }
    .progress-fill { background: linear-gradient(90deg, #a855f7, #ec4899); height: 100%; border-radius: 999px; }
    .objetivo-values { display: flex; justify-content: space-between; font-size: 0.8rem; }
    .componente-item { background: #f9fafb; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.6rem; display: flex; justify-content: space-between; align-items: center; }
    .componente-nombre { font-weight: 600; font-size: 0.9rem; }
    .componente-precio { text-align: right; }
    .componente-usd { color: #0e9f6e; font-weight: 700; }
    .componente-bs { font-size: 0.8rem; color: #6b7280; }
    .membresia-card { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); border-radius: 10px; padding: 1.2rem; color: white; }
    .membresia-label { font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.3rem; }
    .membresia-value { font-size: 1.4rem; font-weight: 800; margin-bottom: 0.5rem; }
    .membresia-info { font-size: 0.75rem; opacity: 0.85; }
    .membresia-warning { background: #fee2e2; color: #991b1b; border-radius: 6px; padding: 0.6rem; margin-top: 0.8rem; font-size: 0.8rem; font-weight: 600; }
    footer { background: #1f2937; color: white; text-align: center; padding: 1rem; margin-top: 2rem; font-size: 0.8rem; }
    @media (max-width: 768px) {
      .header { padding: 1rem; }
      .header h1 { font-size: 1.4rem; }
      .container { padding: 0.8rem; }
      .tasas-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .table-wrapper { max-height: 400px; }
    }
  </style>
</head>
<body>

<div class="header">
  <h1>üéÆ OSRS Tracker</h1>
  <p>Seguimiento integral de farmeo, objetivos y metas</p>
  <div class="header-info">
    <div class="info-card">
      <div class="info-label">üìÖ Inicio</div>
      <div class="info-value">11-Feb-2026</div>
    </div>
    <div class="info-card">
      <div class="info-label">üìç Ubicaci√≥n</div>
      <div class="info-value">Matur√≠n, VE</div>
    </div>
    <div class="info-card" onclick="abrirModalBank()" style="cursor: pointer;">
      <div class="info-label">üí∞ Bank</div>
      <div class="info-value" id="bankGP">44.5 m</div>
      <div class="info-sub" id="bankBs">0 Bs</div>
    </div>
  </div>
</div>

<div class="container">

  <!-- TASAS -->
  <div class="section-title">üí∞ Tasas de Cambio</div>
  <div class="tasas-grid">
    <div class="tasa-card bcv">
      <div class="tasa-label">BCV (USD/VES)</div>
      <div class="tasa-value" id="tasaBCVVal">402.33</div>
      <div style="font-size: 0.7rem; color: #6b7280;">Oficial ‚Ä¢ 20 Feb</div>
    </div>
    <div class="tasa-card binance">
      <div class="tasa-label">Binance P2P (USD/VES)</div>
      <div class="tasa-value" id="tasaBinanceVal">583.00</div>
      <div style="font-size: 0.7rem; color: #6b7280;">Promedio ‚Ä¢ 20 Feb</div>
    </div>
    <div class="tasa-card gp">
      <div class="tasa-label">GP/USD</div>
      <div class="tasa-value" id="tasaGPVal">0.0002</div>
      <button class="btn-edit" onclick="abrirModalTasaGP()">Editar</button>
    </div>
  </div>

  <!-- PAGOS DEL CURSO -->
  <div class="section-title">üí∏ Pagos del Curso</div>
  <div class="card">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Mes</th>
            <th>L√≠mite</th>
            <th>Monto</th>
            <th>Bs</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody id="pagosBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- COMPONENTES PC -->
  <div class="section-title">üñ•Ô∏è Componentes PC</div>
  <div class="card">
    <div id="componentesGrid"></div>
    <div style="background: #f3f4f6; border-radius: 8px; padding: 1rem; margin-top: 1rem;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
        <span style="font-weight: 700;">Total USD</span>
        <span style="color: #0e9f6e; font-weight: 800;" id="totalComponentesUSD">$630</span>
      </div>
      <div style="display: flex; justify-content: space-between;">
        <span style="font-weight: 700;">Total Bs</span>
        <span style="color: #1d4ed8; font-weight: 800;" id="totalComponentesBS">340,200 Bs</span>
      </div>
    </div>
  </div>

  <!-- MEMBRES√çA -->
  <div class="section-title">üé´ Membres√≠a OSRS</div>
  <div class="card">
    <div class="membresia-card">
      <div class="membresia-label">D√≠as Restantes</div>
      <div class="membresia-value" id="diasRestantes">8</div>
      <div class="membresia-info">
        <div>Comprada: 15 Feb 2026</div>
        <div>Vencimiento: 28 Feb 2026</div>
        <div style="margin-top: 0.3rem;">Precio: $10.99 (5,930 Bs)</div>
      </div>
      <div class="membresia-warning" id="membresia-warning">‚ö†Ô∏è Renovar antes del 28 de febrero</div>
    </div>
  </div>

  <!-- FARMEO -->
  <div class="section-title">üìÖ Farmeo Diario</div>
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
      <button class="btn-primary" onclick="abrirModalFarmeo()">‚ûï A√±adir D√≠a</button>
      <div class="pagination">
        <button class="btn-secondary" onclick="paginaAnterior()">‚Üê</button>
        <span style="font-weight: 600; min-width: 40px; text-align: center;" id="paginaInfo">1/1</span>
        <button class="btn-secondary" onclick="paginaSiguiente()">‚Üí</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>D√≠a</th>
            <th>Fecha</th>
            <th>GP / 15-20m</th>
            <th>ToB</th>
            <th>Drops</th>
            <th>Notas</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="farmeoBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- GR√ÅFICA -->
  <div class="section-title">üìà Gr√°fica de Progreso</div>
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem;">
      <button class="btn-secondary" onclick="mesAnterior()">‚Üê Mes Anterior</button>
      <span style="font-weight: 600;" id="mesActual">Febrero 2026</span>
      <button class="btn-secondary" onclick="mesSiguiente()">Mes Siguiente ‚Üí</button>
    </div>
    <div class="chart-container">
      <canvas id="farmeoChart"></canvas>
    </div>
  </div>

  <!-- AN√ÅLISIS -->
  <div class="section-title">üìä An√°lisis de Rendimiento</div>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üìà</div>
      <div class="stat-label">Promedio</div>
      <div class="stat-value" id="promedioDiario">0 m</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìÖ</div>
      <div class="stat-label">Total</div>
      <div class="stat-value" id="totalGenerado">0 m</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚ö°</div>
      <div class="stat-label">D√≠as</div>
      <div class="stat-value" id="totalDias">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üíé</div>
      <div class="stat-label">Bank USD</div>
      <div class="stat-value" id="valorBank">$0</div>
    </div>
  </div>

  <!-- OBJETIVOS -->
  <div class="section-title">üéØ Objetivos</div>
  <div class="card">
    <button class="btn-primary" style="margin-bottom: 1rem;" onclick="abrirModalObjetivo()">‚ûï Nuevo</button>
    <div id="objetivosGrid"></div>
  </div>

</div>

<!-- MODALES -->
<div id="modalFarmeo" class="modal">
  <div class="modal-content">
    <h2>‚ûï A√±adir D√≠a de Farmeo</h2>
    <input type="date" id="farmeoFecha" />
    <input type="number" id="farmeoGP" placeholder="GP Farmeado (millones)" step="0.1" />
    <input type="number" id="farmeoToB" placeholder="ToB (cantidad)" step="1" />
    <select id="farmeoPurple" onchange="togglePurpleInput()">
      <option value="none">Sin Purple</option>
      <option value="scythe">Scythe of Vitur (1600m)</option>
      <option value="sang">Sang Staff (19.6m)</option>
      <option value="justiciar_face">Justiciar Faceguard (180m)</option>
      <option value="justiciar_body">Justiciar Body (250m)</option>
      <option value="justiciar_legs">Justiciar Legs (220m)</option>
      <option value="ghrazi">Ghrazi Rapier (31m)</option>
      <option value="avernic">Avernic Defender (90m)</option>
      <option value="other">Otro (especificar GP)</option>
    </select>
    <input type="number" id="farmeoPurpleGP" placeholder="GP del Purple (millones)" step="0.1" style="display: none;" />
    <textarea id="farmeoNotas" placeholder="Notas" rows="2"></textarea>
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalFarmeo()">Cancelar</button>
      <button class="btn-primary" onclick="guardarFarmeo()">Guardar</button>
    </div>
  </div>
</div>

<div id="modalEditarFarmeo" class="modal">
  <div class="modal-content">
    <h2>‚úèÔ∏è Editar D√≠a de Farmeo</h2>
    <input type="date" id="editFarmeoFecha" />
    <input type="number" id="editFarmeoGP" placeholder="GP Farmeado (millones)" step="0.1" />
    <input type="number" id="editFarmeoToB" placeholder="ToB (cantidad)" step="1" />
    <textarea id="editFarmeoNotas" placeholder="Notas" rows="2"></textarea>
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalEditarFarmeo()">Cancelar</button>
      <button class="btn-primary" onclick="guardarEditarFarmeo()">Guardar Cambios</button>
    </div>
  </div>
</div>

<div id="modalTasaGP" class="modal">
  <div class="modal-content">
    <h2>Editar Tasa GP/USD</h2>
    <input type="number" id="inputTasaGP" step="0.00001" />
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalTasaGP()">Cancelar</button>
      <button class="btn-primary" onclick="guardarTasaGP()">Guardar</button>
    </div>
  </div>
</div>

<div id="modalBank" class="modal">
  <div class="modal-content">
    <h2>Editar Bank Actual</h2>
    <input type="number" id="inputBankGP" placeholder="Bank (millones de GP)" step="0.1" />
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalBank()">Cancelar</button>
      <button class="btn-primary" onclick="guardarBank()">Guardar</button>
    </div>
  </div>
</div>

<div id="modalObjetivo" class="modal">
  <div class="modal-content">
    <h2>‚ûï Nuevo Objetivo</h2>
    <input type="text" id="inputObjetivoNombre" placeholder="Nombre" />
    <input type="number" id="inputObjetivoMeta" placeholder="Meta (millones de GP)" step="0.1" />
    <input type="text" id="inputObjetivoPlazo" placeholder="Plazo" />
    <div class="modal-buttons">
      <button class="btn-secondary" onclick="cerrarModalObjetivo()">Cancelar</button>
      <button class="btn-primary" onclick="guardarObjetivo()">Guardar</button>
    </div>
  </div>
</div>

<footer>
  <p>üéÆ OSRS Tracker v1.0 ‚Ä¢ √öltima actualizaci√≥n: 20 de febrero de 2026</p>
</footer>

<script>
  let state = {
    nextId: 11,
    farmeo: [],
    objetivos: [],
    tasaGP: 0.0002,
    tasaBCV: 402.3343,
    tasaBinance: 583,
    bankActualGP: 44.5,
    pagos: [],
    componentes: [],
    membresia: {}
  };

  let tasaBCVActual = 402.3343;
  let tasaBinanceActual = 583;
  let chartFarmeo = null;
  let paginaActualFarmeo = 1;
  const diasPorPagina = 10;
  let mesActualGrafica = new Date();
  let editandoFarmeoId = null;

  // PRECIOS DE PURPLES (OSRS GE REALES)
  const preciosPurples = {
    'scythe': 1600,
    'sang': 19.6,
    'justiciar_face': 0.18,
    'justiciar_body': 0.25,
    'justiciar_legs': 0.22,
    'ghrazi': 31,
    'avernic': 0.09
  };

  // CARGAR DATOS
  async function cargarDatos() {
    try {
      const response = await fetch("data.json?t=" + Date.now());
      if (response.ok) {
        const data = await response.json();
        state.nextId = data.nextId || 11;
        state.farmeo = data.farmeo || [];
        state.objetivos = data.objetivos || [];
        state.tasaGP = data.tasaGP || 0.0002;
        state.tasaBCV = data.tasaBCV || 402.3343;
        state.tasaBinance = data.tasaBinance || 583;
        state.bankActualGP = data.bankActualGP || 44.5;
        state.pagos = data.pagos || [];
        state.componentes = data.componentes || [];
        state.membresia = data.membresia || {};
        tasaBCVActual = state.tasaBCV;
        tasaBinanceActual = state.tasaBinance;
        console.log("‚úÖ Datos cargados correctamente");
      }
    } catch (e) {
      console.error("‚ùå Error cargando datos:", e);
    }
  }

  function guardarDatos() {
    console.log("üíæ Datos guardados (Manus actualizar√° en GitHub)");
  }

  // UTILIDADES
  function formatFecha(f) {
    const d = new Date(f + 'T00:00:00Z');
    return d.toLocaleDateString('es-VE');
  }

  function actualizarTotales() {
    let totalGP = 0;
    state.farmeo.forEach(d => totalGP += d.gp);
    
    const promedio = state.farmeo.length > 0 ? totalGP / state.farmeo.length : 0;
    const usd = totalGP * state.tasaGP;
    
    document.getElementById('totalGenerado').textContent = totalGP.toFixed(1) + ' m';
    document.getElementById('promedioDiario').textContent = promedio.toFixed(1) + ' m';
    document.getElementById('totalDias').textContent = state.farmeo.length;
    document.getElementById('valorBank').textContent = '$' + usd.toFixed(2);
  }

  // TASAS
  function renderTasas() {
    document.getElementById('tasaBCVVal').textContent = tasaBCVActual.toFixed(2);
    document.getElementById('tasaBinanceVal').textContent = tasaBinanceActual.toFixed(2);
    document.getElementById('tasaGPVal').textContent = state.tasaGP.toFixed(5);
  }

  function abrirModalTasaGP() {
    document.getElementById('inputTasaGP').value = state.tasaGP;
    document.getElementById('modalTasaGP').classList.add('active');
  }

  function cerrarModalTasaGP() {
    document.getElementById('modalTasaGP').classList.remove('active');
  }

  function guardarTasaGP() {
    const val = parseFloat(document.getElementById('inputTasaGP').value);
    if (!isNaN(val) && val > 0) {
      state.tasaGP = val;
      guardarDatos();
      renderTasas();
      renderBank();
      actualizarTotales();
      cerrarModalTasaGP();
    }
  }

  // BANK
  function renderBank() {
    document.getElementById('bankGP').textContent = state.bankActualGP.toFixed(1) + ' m';
    const usd = state.bankActualGP * state.tasaGP;
    const bs = usd * tasaBCVActual;
    document.getElementById('bankBs').textContent = bs.toFixed(0) + ' Bs';
  }

  function abrirModalBank() {
    document.getElementById('inputBankGP').value = state.bankActualGP;
    document.getElementById('modalBank').classList.add('active');
  }

  function cerrarModalBank() {
    document.getElementById('modalBank').classList.remove('active');
  }

  function guardarBank() {
    const val = parseFloat(document.getElementById('inputBankGP').value);
    if (!isNaN(val)) {
      state.bankActualGP = val;
      guardarDatos();
      renderBank();
      actualizarTotales();
      cerrarModalBank();
    }
  }

  // FARMEO
  function abrirModalFarmeo() {
    const hoy = new Date().toISOString().split('T')[0];
    document.getElementById('farmeoFecha').value = hoy;
    document.getElementById('farmeoGP').value = '';
    document.getElementById('farmeoToB').value = '';
    document.getElementById('farmeoPurple').value = 'none';
    document.getElementById('farmeoNotas').value = '';
    document.getElementById('farmeoPurpleGP').style.display = 'none';
    document.getElementById('modalFarmeo').classList.add('active');
  }

  function cerrarModalFarmeo() {
    document.getElementById('modalFarmeo').classList.remove('active');
  }

  function togglePurpleInput() {
    const val = document.getElementById('farmeoPurple').value;
    document.getElementById('farmeoPurpleGP').style.display = (val === 'other') ? 'block' : 'none';
  }

  function guardarFarmeo() {
    const fecha = document.getElementById('farmeoFecha').value;
    let gp = parseFloat(document.getElementById('farmeoGP').value) || 0;
    const tob = parseInt(document.getElementById('farmeoToB').value) || 0;
    const purple = document.getElementById('farmeoPurple').value;
    let notas = document.getElementById('farmeoNotas').value;

    if (!fecha) { alert('Selecciona una fecha'); return; }

    if (purple !== 'none' && purple !== 'other') {
      const precio = preciosPurples[purple] || 0;
      gp += precio;
      notas += ` [${purple}: ${precio}m]`;
    } else if (purple === 'other') {
      const precio = parseFloat(document.getElementById('farmeoPurpleGP').value) || 0;
      if (precio > 0) {
        gp += precio;
        notas += ` [Purple: ${precio}m]`;
      }
    }

    state.farmeo.push({ id: state.nextId++, fecha, gp, tob, notas });
    state.farmeo.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    guardarDatos();
    renderFarmeo();
    cerrarModalFarmeo();
  }

  function abrirModalEditarFarmeo(id) {
    const dia = state.farmeo.find(d => d.id === id);
    if (!dia) return;
    
    editandoFarmeoId = id;
    document.getElementById('editFarmeoFecha').value = dia.fecha;
    document.getElementById('editFarmeoGP').value = dia.gp;
    document.getElementById('editFarmeoToB').value = dia.tob;
    document.getElementById('editFarmeoNotas').value = dia.notas;
    document.getElementById('modalEditarFarmeo').classList.add('active');
  }

  function cerrarModalEditarFarmeo() {
    document.getElementById('modalEditarFarmeo').classList.remove('active');
    editandoFarmeoId = null;
  }

  function guardarEditarFarmeo() {
    if (!editandoFarmeoId) return;
    
    const dia = state.farmeo.find(d => d.id === editandoFarmeoId);
    if (!dia) return;

    dia.fecha = document.getElementById('editFarmeoFecha').value;
    dia.gp = parseFloat(document.getElementById('editFarmeoGP').value) || 0;
    dia.tob = parseInt(document.getElementById('editFarmeoToB').value) || 0;
    dia.notas = document.getElementById('editFarmeoNotas').value;

    state.farmeo.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    guardarDatos();
    renderFarmeo();
    cerrarModalEditarFarmeo();
  }

  function renderFarmeo() {
    const tbody = document.getElementById('farmeoBody');
    tbody.innerHTML = '';

    const totalPags = Math.ceil(state.farmeo.length / diasPorPagina) || 1;
    const inicio = (paginaActualFarmeo - 1) * diasPorPagina;
    const diasPag = state.farmeo.slice(inicio, inicio + diasPorPagina);

    diasPag.forEach(dia => {
      const idx = state.farmeo.indexOf(dia) + 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx}</td>
        <td>${formatFecha(dia.fecha)}</td>
        <td class="gp-cell" onclick="abrirModalEditarFarmeo(${dia.id})">${dia.gp.toFixed(1)} / 15-20m</td>
        <td>${dia.tob || 0} / 5</td>
        <td>${dia.notas.includes('[') ? 'üíé' : '‚Äî'}</td>
        <td title="${dia.notas}" style="max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${dia.notas}</td>
        <td><button class="btn-delete" onclick="eliminarDia(${dia.id})">üóë</button></td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('paginaInfo').textContent = `${paginaActualFarmeo}/${totalPags}`;
    actualizarTotales();
    renderGrafica();
  }

  function eliminarDia(id) {
    if (confirm('¬øEliminar este d√≠a?')) {
      state.farmeo = state.farmeo.filter(d => d.id !== id);
      guardarDatos();
      renderFarmeo();
    }
  }

  function paginaAnterior() {
    if (paginaActualFarmeo > 1) {
      paginaActualFarmeo--;
      renderFarmeo();
    }
  }

  function paginaSiguiente() {
    const total = Math.ceil(state.farmeo.length / diasPorPagina);
    if (paginaActualFarmeo < total) {
      paginaActualFarmeo++;
      renderFarmeo();
    }
  }

  // GR√ÅFICA
  function renderGrafica() {
    const mes = mesActualGrafica.getMonth();
    const a√±o = mesActualGrafica.getFullYear();
    const dias = state.farmeo.filter(d => {
      const f = new Date(d.fecha + 'T00:00:00Z');
      return f.getUTCMonth() === mes && f.getUTCFullYear() === a√±o;
    });

    const labels = dias.map(d => 'D' + new Date(d.fecha + 'T00:00:00Z').getUTCDate());
    const datos = dias.map(d => d.gp);

    const ctx = document.getElementById('farmeoChart');
    if (!ctx) return;
    if (chartFarmeo) chartFarmeo.destroy();

    chartFarmeo = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'GP Farmeado',
          data: datos,
          backgroundColor: '#0e9f6e',
          borderColor: '#059669',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: true } },
        scales: { y: { beginAtZero: true } }
      }
    });

    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    document.getElementById('mesActual').textContent = meses[mes] + ' ' + a√±o;
  }

  function mesAnterior() {
    mesActualGrafica.setMonth(mesActualGrafica.getMonth() - 1);
    renderGrafica();
  }

  function mesSiguiente() {
    mesActualGrafica.setMonth(mesActualGrafica.getMonth() + 1);
    renderGrafica();
  }

  // OBJETIVOS
  function renderObjetivos() {
    const grid = document.getElementById('objetivosGrid');
    grid.innerHTML = '';
    state.objetivos.forEach(obj => {
      const pct = Math.min((obj.actual / obj.meta) * 100, 100);
      const div = document.createElement('div');
      div.className = 'objetivo-item';
      div.innerHTML = `
        <div class="objetivo-header">
          <span class="objetivo-name">${obj.nombre}</span>
          <button class="btn-delete" onclick="eliminarObjetivo(${obj.id})">üóë</button>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${pct}%"></div>
        </div>
        <div class="objetivo-values">
          <span>Actual: <strong contenteditable="true" onblur="editarActualObjetivo(${obj.id}, this.textContent)">${obj.actual.toFixed(1)}</strong> m</span>
          <span>Meta: <strong>${obj.meta.toFixed(1)}</strong> m</span>
        </div>
        <div style="font-size: 0.75rem; color: #6b7280;">üìÖ ${obj.plazo}</div>
        ${obj.detalles ? `<div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.3rem;">D6: ${obj.detalles.dia6} | D7: ${obj.detalles.dia7} | D8: ${obj.detalles.dia8} | D9: ${obj.detalles.dia9}</div>` : ''}
      `;
      grid.appendChild(div);
    });
  }

  function abrirModalObjetivo() {
    document.getElementById('inputObjetivoNombre').value = '';
    document.getElementById('inputObjetivoMeta').value = '';
    document.getElementById('inputObjetivoPlazo').value = '';
    document.getElementById('modalObjetivo').classList.add('active');
  }

  function cerrarModalObjetivo() {
    document.getElementById('modalObjetivo').classList.remove('active');
  }

  function guardarObjetivo() {
    const nombre = document.getElementById('inputObjetivoNombre').value;
    const meta = parseFloat(document.getElementById('inputObjetivoMeta').value);
    const plazo = document.getElementById('inputObjetivoPlazo').value;
    if (nombre && meta > 0) {
      state.objetivos.push({ id: state.nextId++, nombre, meta, actual: 0, plazo });
      guardarDatos();
      renderObjetivos();
      cerrarModalObjetivo();
    }
  }

  function editarActualObjetivo(id, text) {
    const obj = state.objetivos.find(o => o.id === id);
    if (obj) {
      const val = parseFloat(text);
      if (!isNaN(val)) {
        obj.actual = val;
        guardarDatos();
        renderObjetivos();
      }
    }
  }

  function eliminarObjetivo(id) {
    if (confirm('¬øEliminar?')) {
      state.objetivos = state.objetivos.filter(o => o.id !== id);
      guardarDatos();
      renderObjetivos();
    }
  }

  // PAGOS
  function renderPagos() {
    const tbody = document.getElementById('pagosBody');
    tbody.innerHTML = '';

    state.pagos.forEach(pago => {
      const hoy = new Date();
      const limite = new Date(pago.fechaLimite + 'T00:00:00Z');
      let monto = pago.monto;
      let estado = pago.estado;
      let color = '#fef3c7';
      let textColor = '#92400e';

      if (estado === 'Pagado') {
        color = '#d1fae5';
        textColor = '#065f46';
      } else if (limite < hoy && estado === 'Pendiente') {
        monto *= 1.5;
        estado = 'Mora';
        color = '#fee2e2';
        textColor = '#991b1b';
        pago.estado = 'Mora';
      } else if (estado === 'Mora') {
        color = '#fee2e2';
        textColor = '#991b1b';
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${pago.mes}</td>
        <td>${formatFecha(pago.fechaLimite)}</td>
        <td style="color: #0e9f6e; font-weight: 700;">$${monto.toFixed(2)}</td>
        <td>${(monto * tasaBCVActual).toFixed(0)} Bs</td>
        <td><button class="btn-edit" onclick="toggleEstadoPago(${pago.id})" style="background: ${color}; color: ${textColor}; border: none; padding: 0.3rem 0.6rem;">${estado}</button></td>
      `;
      tbody.appendChild(tr);
    });

    guardarDatos();
  }

  function toggleEstadoPago(id) {
    const pago = state.pagos.find(p => p.id === id);
    if (pago) {
      if (pago.estado === 'Pendiente') pago.estado = 'Pagado';
      else if (pago.estado === 'Pagado') pago.estado = 'Pendiente';
      else if (pago.estado === 'Mora') pago.estado = 'Pagado';
      guardarDatos();
      renderPagos();
    }
  }

  // COMPONENTES PC
  function renderComponentes() {
    const grid = document.getElementById('componentesGrid');
    grid.innerHTML = '';
    state.componentes.forEach(comp => {
      const div = document.createElement('div');
      div.className = 'componente-item';
      div.innerHTML = `
        <div class="componente-nombre">${comp.nombre}</div>
        <div class="componente-precio">
          <div class="componente-usd">$${comp.precioUSD}</div>
          <div class="componente-bs">${comp.precioBS.toLocaleString('es-VE')} Bs</div>
        </div>
      `;
      grid.appendChild(div);
    });

    const totalUSD = state.totalComponentesUSD || 630;
    const totalBS = state.totalComponentesBS || 340200;
    document.getElementById('totalComponentesUSD').textContent = '$' + totalUSD;
    document.getElementById('totalComponentesBS').textContent = totalBS.toLocaleString('es-VE') + ' Bs';
  }

  // MEMBRES√çA
  function renderMembresia() {
    if (!state.membresia.fechaCompra) return;

    const fechaCompra = new Date(state.membresia.fechaCompra + 'T00:00:00Z');
    const fechaVencimiento = new Date(state.membresia.fechaVencimiento + 'T00:00:00Z');
    const hoy = new Date();
    
    let diasRestantes = Math.ceil((fechaVencimiento - hoy) / (1000 * 60 * 60 * 24));
    if (diasRestantes < 0) diasRestantes = 0;

    document.getElementById('diasRestantes').textContent = diasRestantes;

    const warning = document.getElementById('membresia-warning');
    if (diasRestantes <= 7) {
      warning.style.display = 'block';
      warning.textContent = `‚ö†Ô∏è ${diasRestantes} d√≠as para renovar (vence ${formatFecha(state.membresia.fechaVencimiento)})`;
    } else {
      warning.style.display = 'none';
    }
  }

  // INICIALIZAR
  async function init() {
    await cargarDatos();
    renderTasas();
    renderBank();
    renderFarmeo();
    renderObjetivos();
    renderPagos();
    renderComponentes();
    renderMembresia();
    console.log("‚úÖ Aplicaci√≥n inicializada");
  }

  init();
</script>
</body>
</html>
